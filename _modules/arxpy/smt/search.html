

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>arxpy.smt.search &mdash; ArxPy 0.2.alpha documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ArxPy
          

          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../arxpy.html">ArxPy 0.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../arxpy.html#subpackages">Subpackages</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ArxPy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>arxpy.smt.search</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for arxpy.smt.search</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Search for characteristics by modeling the search as a SMT problem.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">pysmt</span> <span class="kn">import</span> <span class="n">environment</span>
<span class="kn">from</span> <span class="nn">pysmt</span> <span class="kn">import</span> <span class="n">logics</span>

<span class="kn">from</span> <span class="nn">arxpy.bitvector</span> <span class="kn">import</span> <span class="n">core</span>
<span class="kn">from</span> <span class="nn">arxpy.bitvector</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">arxpy.bitvector</span> <span class="kn">import</span> <span class="n">operation</span>
<span class="kn">from</span> <span class="nn">arxpy.bitvector</span> <span class="kn">import</span> <span class="n">extraop</span>
<span class="kn">from</span> <span class="nn">arxpy.differential</span> <span class="kn">import</span> <span class="n">difference</span>
<span class="kn">from</span> <span class="nn">arxpy.differential</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">arxpy.differential</span> <span class="kn">import</span> <span class="n">characteristic</span>
<span class="kn">from</span> <span class="nn">arxpy.smt</span> <span class="kn">import</span> <span class="n">types</span>
<span class="kn">from</span> <span class="nn">arxpy.smt</span> <span class="kn">import</span> <span class="n">verification</span>


<span class="c1"># default arguments for checking empirical weights</span>
<span class="n">MIN_PAIRS</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">MAX_PAIRS</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">KEY_SAMPLES</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">MAX_CH_FOUND</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">10</span>


<span class="k">def</span> <span class="nf">_get_smart_print</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">smart_print</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">fh</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">smart_print</span>


<span class="k">def</span> <span class="nf">_get_time</span><span class="p">():</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span>


<div class="viewcode-block" id="DerMode"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.DerMode">[docs]</a><span class="k">class</span> <span class="nc">DerMode</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent the different constraints available for the derivative weights of a characteristic.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Default: no additional constraint is added</span>
<span class="sd">        ProbabilityOne: fix all derivative weights to zero</span>
<span class="sd">        Valid: only the validity constraint is added (weight is ignored)</span>
<span class="sd">        XDCA_Approx: for the weights of `XDCA`, the ``precision`` is set to ``0``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Default</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">ProbabilityOne</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">Valid</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">XDCA_Approx</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span></div>


<div class="viewcode-block" id="ChSearchMode"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.ChSearchMode">[docs]</a><span class="k">class</span> <span class="nc">ChSearchMode</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent the different options for searching `BvCharacteristic`.</span>

<span class="sd">    A characteristic is said to be *valid* if its weight</span>
<span class="sd">    :math:`w = - \log_2(p)`, where *p* is the probability of the characteristic,</span>
<span class="sd">    is lower than the bit-size of the input difference.</span>

<span class="sd">    A derivative weight is said to be *non-exact* if its weight</span>
<span class="sd">    does not match its exact weight.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        FirstCh: returns the 1st characteristic found by iteratively searching with increasing weight.</span>
<span class="sd">            The characteristic found is returned as a `ChFound` object, but it may not have</span>
<span class="sd">            optimal theoretical weight if it contains a non-exact derivative weight</span>
<span class="sd">            or it may be empirically invalid. If no characteristic is found,</span>
<span class="sd">            ``None`` is returned.</span>
<span class="sd">        FirstChValid: similar to `FirstCh`, but if the characteristic found is</span>
<span class="sd">            empirically invalid (after computing its empirical weight), the search continues.</span>
<span class="sd">        Optimal: similar to `FirstCh`, but several characteristics are found to ensure</span>
<span class="sd">            that the one returned has the optimal theoretical weight.</span>
<span class="sd">            (only differs from `FirstCh` if there is a non-exact derivative weight).</span>
<span class="sd">        OptimalDifferential: similar to `Optimal`, but once a characteristic is found,</span>
<span class="sd">            only characteristics with different input/output differences are searched.</span>
<span class="sd">        AllOptimal: similar to `Optimal`, but the search never stops.</span>
<span class="sd">        TopDifferentials: searches for `MAX_CH_FOUND` characteristics</span>
<span class="sd">            (as in `FirstCh`) and return the differentials obtained</span>
<span class="sd">            by gathering those characteristics.</span>
<span class="sd">        AllValid: a non-stop search of valid characteristics with no</span>
<span class="sd">            additional constraints.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FirstCh</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">FirstChValid</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">Optimal</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">OptimalDifferential</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">AllOptimal</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">AllValid</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">TopDifferentials</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span></div>


<div class="viewcode-block" id="SkChSearchMode"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.SkChSearchMode">[docs]</a><span class="k">class</span> <span class="nc">SkChSearchMode</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent the different options for searching `SingleKeyCh`.</span>

<span class="sd">    The options are the same as `ChSearchMode`, but `SkChFound` objects are returned instead of `ChFound`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FirstCh</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">FirstChValid</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">Optimal</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">OptimalDifferential</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">AllOptimal</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">AllValid</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">TopDifferentials</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span></div>


<div class="viewcode-block" id="RkChSearchMode"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.RkChSearchMode">[docs]</a><span class="k">class</span> <span class="nc">RkChSearchMode</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent the different options for searching `RelatedKeyCh`.</span>

<span class="sd">    A related-key characteristic is said to be *valid* if its encryption weight</span>
<span class="sd">    is lower than the bit-size of the plaintext difference and</span>
<span class="sd">    its key schedule weight is lower than the bit-size of the master-key difference.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        FirstMinSum: returns the 1st related-key characteristic found</span>
<span class="sd">            by iteratively searching with increasing *weight*, where the *weight*</span>
<span class="sd">            is taken as the sum of the key schedule weight and the encryption weight.</span>
<span class="sd">            The characteristic found is returned as a `RkChFound` object,</span>
<span class="sd">            but it may not have optimal theoretical weight if it it contains</span>
<span class="sd">            a non-exact derivative weight or it may be empirically invalid.</span>
<span class="sd">            If no characteristic is found, ``None`` is returned.</span>
<span class="sd">        FirstMinSumValid: similar to `FirstMinSum`, but if the characteristic found is</span>
<span class="sd">            empirically invalid (after computing its empirical weight), the search continues.</span>
<span class="sd">        OptimalMinSum: similar to `FirstMinSum`, but several characteristics are found to ensure</span>
<span class="sd">            that the one returned has the optimal theoretical weight.</span>
<span class="sd">            (only differs from `FirstMinSum` if there is a non-exact derivative weight).</span>
<span class="sd">        OptimalMinSumDifferential: similar to `OptimalMinSum`, but once a characteristic is found,</span>
<span class="sd">            only characteristics with different input/output differences are searched.</span>
<span class="sd">            (to ensure optimality).</span>
<span class="sd">        FirstValidKeyMinEnc: similar to `FirstMinSum`,</span>
<span class="sd">            but the *weight* is taken as the encryption weight and the</span>
<span class="sd">            key schedule weight is restricted to be smaller than the key size.</span>
<span class="sd">        FirstValidKeyMinEncValid: similar to `FirstMinSumValid`,</span>
<span class="sd">            but the *weight* is defined as `FirstValidKeyMinEnc`.</span>
<span class="sd">        OptimalValidKeyMinEnc: similar to `OptimalMinSum`,</span>
<span class="sd">            but the *weight* is defined as `FirstValidKeyMinEnc`.</span>
<span class="sd">        OptimalValidKeyMinEncDifferential: similar to `OptimalMinSumDifferential`,</span>
<span class="sd">            but the *weight* is  defined as `FirstValidKeyMinEnc`.</span>
<span class="sd">        FirstFixEncMinKey: similar to `FirstMinSum`,</span>
<span class="sd">            but the *weight* is taken as the key schedule weight and</span>
<span class="sd">            the encryption weight is fixed to a given value.</span>
<span class="sd">        FirstFixEncMinKeyValid: similar to `FirstMinSumValid`,</span>
<span class="sd">            but the *weight* is defined as `FirstFixEncMinKey`.</span>
<span class="sd">        OptimalFixEncMinKey: similar to `OptimalMinSum`,</span>
<span class="sd">            but the *weight* is defined as `FirstFixEncMinKey`.</span>
<span class="sd">        OptimalFixEncMinKeyDifferential: similar to `OptimalMinSumDifferential`,</span>
<span class="sd">            but the *weight* is defined as `FirstFixEncMinKey`.</span>
<span class="sd">        AllOptimalMinSum: similar to `OptimalMinSum`, but the search never stops.</span>
<span class="sd">        AllValid: a non-stop search of valid characteristics with no</span>
<span class="sd">            additional constraints.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FirstMinSum</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">FirstMinSumValid</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">OptimalMinSum</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">OptimalMinSumDifferential</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">AllOptimalMinSum</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">FirstValidKeyMinEnc</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">FirstValidKeyMinEncValid</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">OptimalValidKeyMinEnc</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">OptimalValidKeyMinEncDifferential</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">FirstFixEncMinKey</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">FirstFixEncMinKeyValid</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">OptimalFixEncMinKey</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">OptimalFixEncMinKeyDifferential</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">AllValid</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span></div>


<div class="viewcode-block" id="ExactWeightError"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.ExactWeightError">[docs]</a><span class="k">class</span> <span class="nc">ExactWeightError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The exception raised in `ChFound.check_empirical_weight` and similar functions.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="ChFound"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.ChFound">[docs]</a><span class="k">class</span> <span class="nc">ChFound</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent (non-symbolic) characteristics found.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        ch: the associated symbolic characteristic</span>
<span class="sd">        ch_weight: a `Constant` denoting the the characteristic weight</span>
<span class="sd">        der_weights: a list, where the i-th element is a pair containing</span>
<span class="sd">            the i-th derivative symbolic weight and its value</span>
<span class="sd">        input_diff: a list, where the i-th element is a pair containing</span>
<span class="sd">            the i-th input symbolic difference and its value</span>
<span class="sd">        nonlinear_diffs: aa list, where the i-th element is a pair containing</span>
<span class="sd">            the i-th non-linear symbolic difference and its value</span>
<span class="sd">        output_diff: a list, where the i-th element is a pair containing</span>
<span class="sd">            the i-th output symbolic difference and its value</span>

<span class="sd">    ::</span>

<span class="sd">        &gt;&gt;&gt; from arxpy.bitvector.operation import BvComp</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.differential.difference import XorDiff, RXDiff</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.differential.characteristic import BvCharacteristic</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.primitives.chaskey import ChaskeyPi</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.smt.search import SearchCh</span>
<span class="sd">        &gt;&gt;&gt; ChaskeyPi.set_rounds(1)</span>
<span class="sd">        &gt;&gt;&gt; ch = BvCharacteristic(ChaskeyPi, XorDiff, [&quot;dv0&quot;, &quot;dv1&quot;, &quot;dv2&quot;, &quot;dv3&quot;])</span>
<span class="sd">        &gt;&gt;&gt; search_problem = SearchCh(ch)</span>
<span class="sd">        &gt;&gt;&gt; ch_found = search_problem.solve(0)</span>
<span class="sd">        &gt;&gt;&gt; ch_found.ch_weight</span>
<span class="sd">        0b0000000</span>
<span class="sd">        &gt;&gt;&gt; ch_found.der_weights</span>
<span class="sd">        [[w0w1w2, 0b0000000], [w3, 0b00000]]</span>
<span class="sd">        &gt;&gt;&gt; ch_found.input_diff  # doctest: +ELLIPSIS,+NORMALIZE_WHITESPACE</span>
<span class="sd">        [[XorDiff(dv0), XorDiff(...)], [XorDiff(dv1), XorDiff(...)],</span>
<span class="sd">        [XorDiff(dv2), XorDiff(...)], [XorDiff(dv3), XorDiff(...)]]</span>
<span class="sd">        &gt;&gt;&gt; ch_found.nonlinear_diffs  # doctest: +ELLIPSIS,+NORMALIZE_WHITESPACE</span>
<span class="sd">        [[XorDiff(d0), XorDiff(...)], [XorDiff(d4), XorDiff(...)],</span>
<span class="sd">        [XorDiff(d7), XorDiff(...)], [XorDiff(d10), XorDiff(...)]]</span>
<span class="sd">        &gt;&gt;&gt; ch_found.output_diff  # doctest: +ELLIPSIS,+NORMALIZE_WHITESPACE</span>
<span class="sd">        [[XorDiff(d7), XorDiff(...)], [XorDiff(d12), XorDiff(...)],</span>
<span class="sd">        [XorDiff(d13), XorDiff(...)], [XorDiff(d9), XorDiff(...)]]</span>
<span class="sd">        &gt;&gt;&gt; print(ch_found)  # doctest: +ELLIPSIS</span>
<span class="sd">        {&#39;ch_weight&#39;: 0,</span>
<span class="sd">         &#39;der_weights&#39;: [[w0w1w2, 0], [w3, 0]],</span>
<span class="sd">         &#39;exact_weight&#39;: 0,</span>
<span class="sd">         &#39;input_diff&#39;: [[dv0, ...], [dv1, ...], [dv2, ...], [dv3, ...]],</span>
<span class="sd">         &#39;nonlinear_diffs&#39;: [[d0, ...], [d4, ...], [d7, ...], [d10, ...]],</span>
<span class="sd">         &#39;output_diff&#39;: [[d7, ...], [d12, ...], [d13, ...], [d9, ...]]}</span>
<span class="sd">        &gt;&gt;&gt; ch = BvCharacteristic(ChaskeyPi, RXDiff, [&quot;dv0&quot;, &quot;dv1&quot;, &quot;dv2&quot;, &quot;dv3&quot;])</span>
<span class="sd">        &gt;&gt;&gt; ic = [BvComp(0, d.val) for d in ch.input_diff]</span>
<span class="sd">        &gt;&gt;&gt; ic += [BvComp(0, d[1].val) for d in ch.output_diff]</span>
<span class="sd">        &gt;&gt;&gt; search_problem = SearchCh(ch, allow_zero_input_diff=True, initial_constraints=ic)</span>
<span class="sd">        &gt;&gt;&gt; ch_found = search_problem.solve(5)</span>
<span class="sd">        &gt;&gt;&gt; ch_found.ch_weight</span>
<span class="sd">        0x05</span>
<span class="sd">        &gt;&gt;&gt; ch_found.der_weights</span>
<span class="sd">        [[w0, 0b000001011], [w1, 0b000001011], [w2, 0b000001011], [w3, 0b000001011]]</span>
<span class="sd">        &gt;&gt;&gt; ch_found.input_diff  # doctest: +ELLIPSIS,+NORMALIZE_WHITESPACE</span>
<span class="sd">        [[RXDiff(dv0), RXDiff(0x00000000)], [RXDiff(dv1), RXDiff(0x00000000)],</span>
<span class="sd">        [RXDiff(dv2), RXDiff(0x00000000)], [RXDiff(dv3), RXDiff(0x00000000)]]</span>
<span class="sd">        &gt;&gt;&gt; ch_found.nonlinear_diffs  # doctest: +ELLIPSIS,+NORMALIZE_WHITESPACE</span>
<span class="sd">        [[RXDiff(d0), RXDiff(0x00000000)], [RXDiff(d4), RXDiff(0x00000000)],</span>
<span class="sd">        [RXDiff(d7), RXDiff(0x00000000)], [RXDiff(d10), RXDiff(0x00000000)]]</span>
<span class="sd">        &gt;&gt;&gt; ch_found.output_diff  # doctest: +ELLIPSIS,+NORMALIZE_WHITESPACE</span>
<span class="sd">        [[RXDiff(d7), RXDiff(0x00000000)], [RXDiff(d12), RXDiff(0x00000000)],</span>
<span class="sd">        [RXDiff(d13), RXDiff(0x00000000)], [RXDiff(d9), RXDiff(0x00000000)]]</span>
<span class="sd">        &gt;&gt;&gt; print(ch_found)  # doctest: +ELLIPSIS</span>
<span class="sd">        {&#39;ch_weight&#39;: 5,</span>
<span class="sd">         &#39;der_weights&#39;: [[w0, 1.375], [w1, 1.375], [w2, 1.375], [w3, 1.375]],</span>
<span class="sd">         &#39;exact_weight&#39;: 5.66...,</span>
<span class="sd">         &#39;input_diff&#39;: [[dv0, 0x00000000], [dv1, 0x00000000], [dv2, 0x00000000], [dv3, 0x00000000]],</span>
<span class="sd">         &#39;nonlinear_diffs&#39;: [[d0, 0x00000000], [d4, 0x00000000], [d7, 0x00000000], [d10, 0x00000000]],</span>
<span class="sd">         &#39;output_diff&#39;: [[d7, 0x00000000], [d12, 0x00000000], [d13, 0x00000000], [d9, 0x00000000]]}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch_weight</span><span class="p">,</span> <span class="n">der_weights</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">aux_model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">ch_weight</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">aux_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aux_model</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">model</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">aux_model</span><span class="p">}</span>
        <span class="n">diff_model</span> <span class="o">=</span> <span class="p">{</span><span class="n">d</span><span class="p">:</span> <span class="n">model</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">model</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">difference</span><span class="o">.</span><span class="n">Difference</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">free_diffs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">input_diff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff_model</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">free_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="n">diff_model</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">)(</span><span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_diff</span> <span class="o">=</span> <span class="p">[[</span><span class="n">d</span><span class="p">,</span> <span class="n">diff_model</span><span class="p">[</span><span class="n">d</span><span class="p">]]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">input_diff</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_diff</span> <span class="o">=</span> <span class="p">[[</span><span class="n">v</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="n">diff_model</span><span class="p">)]</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">output_diff</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_diffs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">d</span><span class="p">,</span> <span class="n">diff_model</span><span class="p">[</span><span class="n">d</span><span class="p">]]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">der_weights</span> <span class="o">=</span> <span class="p">[[</span><span class="n">w</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="n">w</span><span class="p">]]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">der_weights</span> <span class="k">if</span> <span class="s2">&quot;tmp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">w</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">emp_weight</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_diff_model</span> <span class="o">=</span> <span class="n">diff_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exact_weight</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ChFound.get_exact_weight"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.ChFound.get_exact_weight">[docs]</a>    <span class="k">def</span> <span class="nf">get_exact_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the exact weight of the characteristic found.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exact_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exact_weight</span>

        <span class="n">exact_weight</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">der</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># diff = diff.xreplace(self._diff_model)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">new_input_diff</span> <span class="o">=</span> <span class="p">[(</span><span class="n">d</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_diff_model</span><span class="p">))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">der</span><span class="o">.</span><span class="n">input_diff</span><span class="p">]</span>
            <span class="n">exact_der_weight</span> <span class="o">=</span> <span class="n">der</span><span class="o">.</span><span class="n">_replace_input_diff</span><span class="p">(</span><span class="n">new_input_diff</span><span class="p">)</span><span class="o">.</span><span class="n">exact_weight</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exact_der_weight</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Term</span><span class="p">)</span>
            <span class="n">exact_weight</span> <span class="o">+=</span> <span class="n">exact_der_weight</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">diff_type</span> <span class="o">==</span> <span class="n">difference</span><span class="o">.</span><span class="n">XorDiff</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">exact_weight</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;exact weight </span><span class="si">{}</span><span class="s2"> should be lower than ch.weight </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exact_weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">diff_type</span> <span class="o">==</span> <span class="n">difference</span><span class="o">.</span><span class="n">RXDiff</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">exact_weight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;exact weight </span><span class="si">{}</span><span class="s2"> should be higher than ch.weight </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exact_weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_exact_weight</span> <span class="o">=</span> <span class="n">exact_weight</span>

        <span class="k">return</span> <span class="n">exact_weight</span></div>

    <span class="k">def</span> <span class="nf">signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch_signature_type</span><span class="p">,</span> <span class="n">return_str</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">symbolic_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">ch_signature_type</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">diff_type</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_diff_model</span><span class="p">)</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">symbolic_sig</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">return_str</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sig</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sig</span>

<div class="viewcode-block" id="ChFound.check_empirical_weight"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.ChFound.check_empirical_weight">[docs]</a>    <span class="k">def</span> <span class="nf">check_empirical_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose_lvl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the exact weight of the model matches its empirical weight.</span>

<span class="sd">        If the exact weight doesn&#39;t match, the exception `ExactWeightError` is raised.</span>

<span class="sd">        If ``filename`` is not ``None``, the output will be printed</span>
<span class="sd">        to the given file rather than the to stdout.</span>

<span class="sd">        The argument ``verbose_lvl`` can also take the values ``1`` and ``2`` for a</span>
<span class="sd">        more detailed output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smart_print</span> <span class="o">=</span> <span class="n">_get_smart_print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">input_diff</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_diff</span><span class="p">]</span>
        <span class="n">output_diff</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_diff</span><span class="p">]</span>

        <span class="n">exact_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_weight</span><span class="p">()</span>

        <span class="n">current_max_pairs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">MAX_PAIRS</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">ssa</span><span class="p">[</span><span class="s2">&quot;assignments&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>  <span class="c1"># + 1 to avoid division by 0</span>
            <span class="n">MIN_PAIRS</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>

        <span class="n">pair_samples</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">exact_weight</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">MIN_PAIRS</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="p">,</span> <span class="s2">&quot;_cipher&quot;</span><span class="p">):</span>
            <span class="n">weak_check</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">_cipher</span><span class="p">,</span> <span class="s2">&quot;weak_check&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">_cipher</span><span class="o">.</span><span class="n">weak_check</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weak_check</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;weak_check&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">weak_check</span>

        <span class="k">if</span> <span class="n">pair_samples</span> <span class="o">&gt;</span> <span class="n">current_max_pairs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">weak_check</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">emp_weight</span> <span class="o">=</span> <span class="n">verification</span><span class="o">.</span><span class="n">fast_empirical_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose_lvl</span><span class="o">=</span><span class="n">verbose_lvl</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">weak_check</span> <span class="ow">or</span> <span class="p">(</span><span class="n">weak_check</span> <span class="ow">and</span> <span class="n">exact_weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose_lvl</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;- checking </span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2"> with </span><span class="si">{}</span><span class="s2"> pair samples&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">input_diff</span><span class="p">]),</span>
                    <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">output_diff</span><span class="p">]),</span>
                    <span class="n">pair_samples</span><span class="p">))</span>
            <span class="n">emp_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">empirical_weight</span><span class="p">(</span><span class="n">input_diff</span><span class="p">,</span> <span class="n">output_diff</span><span class="p">,</span> <span class="n">pair_samples</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose_lvl</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;- exact/empirical weight: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exact_weight</span><span class="p">,</span> <span class="n">emp_weight</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">error_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">input_widths</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.03125</span>  <span class="c1"># every 32-bit, 1 unit of error</span>

        <span class="c1"># if not (emp_weight - error_weight &lt;= exact_weight &lt;= emp_weight + error_weight):</span>
        <span class="k">if</span> <span class="n">emp_weight</span> <span class="ow">is</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="n">exact_weight</span> <span class="o">&lt;=</span> <span class="n">emp_weight</span> <span class="o">+</span> <span class="n">error_weight</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The exact and empirical weights do not match</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; - exact weight:     </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exact_weight</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; - empirical weight: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">emp_weight</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">(</span><span class="n">vrepr</span><span class="o">=</span><span class="n">verbose_lvl</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">ExactWeightError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emp_weight</span> <span class="o">=</span> <span class="n">emp_weight</span></div>

    <span class="k">def</span> <span class="nf">_check_empirical_distribution_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cipher</span><span class="p">,</span> <span class="n">verbose_lvl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rk_dict_diffs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># similar to _empirical_distribution_weight of characteristic module</span>
        <span class="n">smart_print</span> <span class="o">=</span> <span class="n">_get_smart_print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">input_diff</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_diff</span><span class="p">]</span>
        <span class="n">output_diff</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_diff</span><span class="p">]</span>

        <span class="n">exact_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_weight</span><span class="p">()</span>

        <span class="n">current_max_pairs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">MAX_PAIRS</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">ssa</span><span class="p">[</span><span class="s2">&quot;assignments&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>  <span class="c1"># + 1 to avoid division by 0</span>
            <span class="n">MIN_PAIRS</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>

        <span class="n">key_samples</span> <span class="o">=</span> <span class="n">KEY_SAMPLES</span>
        <span class="n">pair_samples</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">exact_weight</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">MIN_PAIRS</span><span class="p">)</span>

        <span class="n">weak_check</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cipher</span><span class="p">,</span> <span class="s2">&quot;weak_check&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">cipher</span><span class="o">.</span><span class="n">weak_check</span>

        <span class="k">if</span> <span class="n">key_samples</span> <span class="o">*</span> <span class="n">pair_samples</span> <span class="o">&gt;</span> <span class="n">current_max_pairs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">weak_check</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="n">emp_weight_dist</span> <span class="o">=</span> <span class="n">verification</span><span class="o">.</span><span class="n">_fast_empirical_weight_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cipher</span><span class="p">,</span> <span class="n">rk_dict_diffs</span><span class="p">,</span>
                                                                               <span class="n">verbose_lvl</span><span class="o">=</span><span class="n">verbose_lvl</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">weak_check</span> <span class="ow">or</span> <span class="p">(</span><span class="n">weak_check</span> <span class="ow">and</span> <span class="n">exact_weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose_lvl</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;- checking </span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2"> with </span><span class="si">{}</span><span class="s2"> pair samples and </span><span class="si">{}</span><span class="s2"> key samples&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">input_diff</span><span class="p">]),</span>
                    <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">output_diff</span><span class="p">]),</span>
                    <span class="n">pair_samples</span><span class="p">,</span> <span class="n">key_samples</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">rk_dict_diffs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rk_output_diff</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rk_dict_diffs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">rk_output_diff</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rk_dict_diffs</span><span class="p">[</span><span class="s2">&quot;output_diff&quot;</span><span class="p">]]</span>
            <span class="n">emp_weight_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">_empirical_weight_distribution</span><span class="p">(</span><span class="n">cipher</span><span class="p">,</span> <span class="n">input_diff</span><span class="p">,</span> <span class="n">output_diff</span><span class="p">,</span> <span class="n">pair_samples</span><span class="p">,</span>
                                                                     <span class="n">key_samples</span><span class="p">,</span> <span class="n">rk_output_diff</span><span class="o">=</span><span class="n">rk_output_diff</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose_lvl</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;- exact/empirical weight: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exact_weight</span><span class="p">,</span> <span class="n">emp_weight_dist</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">error_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">input_widths</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.03125</span>

        <span class="n">max_emp_weight_dist</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">ew</span> <span class="k">for</span> <span class="n">ew</span> <span class="ow">in</span> <span class="n">emp_weight_dist</span> <span class="k">if</span> <span class="n">ew</span> <span class="o">!=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">default</span><span class="o">=-</span><span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="c1"># if not(min(emp_weight_dist) - error_weight &lt;= exact_weight &lt;= max_emp_weight_dist + error_weight):</span>
        <span class="k">if</span> <span class="n">max_emp_weight_dist</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="n">exact_weight</span> <span class="o">&lt;=</span> <span class="n">max_emp_weight_dist</span> <span class="o">+</span> <span class="n">error_weight</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The exact and empirical weights do not match</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; - exact weight:      </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">exact_weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; - empirical weights: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">emp_weight_dist</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">(</span><span class="n">vrepr</span><span class="o">=</span><span class="n">verbose_lvl</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">ExactWeightError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emp_weight</span> <span class="o">=</span> <span class="n">emp_weight_dist</span>

    <span class="k">def</span> <span class="nf">_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vrepr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">DictItem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="n">verbose_repr</span> <span class="o">=</span> <span class="n">vrepr</span>

            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">str_item</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">item</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">str_item</span> <span class="o">=</span> <span class="n">str_item</span>

            <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">vr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">verbose_repr</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">vr</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_item</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Term</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">vr</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">,</span> <span class="n">difference</span><span class="o">.</span><span class="n">Difference</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">vr</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">:</span>
                        <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">DictItem</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
                    <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_args</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid argument </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">))</span>

            <span class="fm">__repr__</span> <span class="o">=</span> <span class="fm">__str__</span>

        <span class="n">ch_weight</span> <span class="o">=</span> <span class="n">DictItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">str_item</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">))</span>
        <span class="n">exact_weight</span> <span class="o">=</span> <span class="n">DictItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_exact_weight</span><span class="p">())</span>
        <span class="n">input_diff</span> <span class="o">=</span> <span class="n">DictItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_diff</span><span class="p">)</span>
        <span class="n">output_diff</span> <span class="o">=</span> <span class="n">DictItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_diff</span><span class="p">)</span>
        <span class="n">nonlinear_diffs</span> <span class="o">=</span> <span class="n">DictItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="p">)</span>

        <span class="n">der_weights_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">der_weights</span><span class="p">[:]</span>
        <span class="n">max_num_frac_bits</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">der</span><span class="o">.</span><span class="n">num_frac_bits</span><span class="p">()</span> <span class="k">for</span> <span class="n">der</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">der_weights_str</span><span class="p">)):</span>
            <span class="n">diff_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">der_weights_str</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_num_frac_bits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">diff_val</span> <span class="o">=</span> <span class="n">diff_val</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">max_num_frac_bits</span><span class="p">)</span>
            <span class="n">der_weights_str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">der_weights_str</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">diff_val</span><span class="p">]</span>
        <span class="n">der_weights</span> <span class="o">=</span> <span class="n">DictItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">der_weights</span><span class="p">,</span> <span class="n">str_item</span><span class="o">=</span><span class="n">der_weights_str</span><span class="p">)</span>

        <span class="n">dict_ch</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ch_weight&#39;</span><span class="p">:</span> <span class="n">ch_weight</span><span class="p">,</span>
            <span class="s1">&#39;exact_weight&#39;</span><span class="p">:</span> <span class="n">exact_weight</span><span class="p">,</span>
            <span class="s1">&#39;input_diff&#39;</span><span class="p">:</span> <span class="n">input_diff</span><span class="p">,</span>
            <span class="s1">&#39;output_diff&#39;</span><span class="p">:</span> <span class="n">output_diff</span><span class="p">,</span>
            <span class="s1">&#39;nonlinear_diffs&#39;</span><span class="p">:</span> <span class="n">nonlinear_diffs</span><span class="p">,</span>
            <span class="s1">&#39;der_weights&#39;</span><span class="p">:</span> <span class="n">der_weights</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">emp_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dict_ch</span><span class="p">[</span><span class="s1">&#39;emp_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DictItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emp_weight</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">free_diffs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dict_ch</span><span class="p">[</span><span class="s1">&#39;free_diffs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DictItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">free_diffs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dict_ch</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">(),</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="ChFound.vrepr"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.ChFound.vrepr">[docs]</a>    <span class="k">def</span> <span class="nf">vrepr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a verbose dictionary-like representation of the characteristic.</span>

<span class="sd">            &gt;&gt;&gt; from arxpy.differential.difference import XorDiff</span>
<span class="sd">            &gt;&gt;&gt; from arxpy.differential.characteristic import BvCharacteristic</span>
<span class="sd">            &gt;&gt;&gt; from arxpy.primitives.chaskey import ChaskeyPi</span>
<span class="sd">            &gt;&gt;&gt; from arxpy.smt.search import SearchCh</span>
<span class="sd">            &gt;&gt;&gt; ChaskeyPi.set_rounds(1)</span>
<span class="sd">            &gt;&gt;&gt; ch = BvCharacteristic(ChaskeyPi, XorDiff, [&quot;dv0&quot;, &quot;dv1&quot;, &quot;dv2&quot;, &quot;dv3&quot;])</span>
<span class="sd">            &gt;&gt;&gt; search_problem = SearchCh(ch)</span>
<span class="sd">            &gt;&gt;&gt; ch_found = search_problem.solve(0)</span>
<span class="sd">            &gt;&gt;&gt; print(ch_found.vrepr())  # doctest:+ELLIPSIS,+NORMALIZE_WHITESPACE</span>
<span class="sd">            {&#39;ch_weight&#39;: Constant(0b0000000, width=7),</span>
<span class="sd">            &#39;exact_weight&#39;: 0,</span>
<span class="sd">            &#39;input_diff&#39;: [[XorDiff(Variable(&#39;dv0&#39;, width=32)), XorDiff(Constant(..., width=32))],</span>
<span class="sd">                [XorDiff(Variable(&#39;dv1&#39;, width=32)), XorDiff(Constant(..., width=32))],</span>
<span class="sd">                [XorDiff(Variable(&#39;dv2&#39;, width=32)), XorDiff(Constant(..., width=32))],</span>
<span class="sd">                [XorDiff(Variable(&#39;dv3&#39;, width=32)), XorDiff(Constant(..., width=32))]],</span>
<span class="sd">            &#39;output_diff&#39;: [[XorDiff(Variable(&#39;d7&#39;, width=32)), XorDiff(Constant(..., width=32))],</span>
<span class="sd">                [XorDiff(Variable(&#39;d12&#39;, width=32)), XorDiff(Constant(..., width=32))],</span>
<span class="sd">                [XorDiff(Variable(&#39;d13&#39;, width=32)), XorDiff(Constant(..., width=32))],</span>
<span class="sd">                [XorDiff(Variable(&#39;d9&#39;, width=32)), XorDiff(Constant(..., width=32))]],</span>
<span class="sd">            &#39;nonlinear_diffs&#39;: [[XorDiff(Variable(&#39;d0&#39;, width=32)), XorDiff(Constant(..., width=32))],</span>
<span class="sd">                [XorDiff(Variable(&#39;d4&#39;, width=32)), XorDiff(Constant(..., width=32))],</span>
<span class="sd">                [XorDiff(Variable(&#39;d7&#39;, width=32)), XorDiff(Constant(..., width=32))],</span>
<span class="sd">                [XorDiff(Variable(&#39;d10&#39;, width=32)), XorDiff(Constant(..., width=32))]],</span>
<span class="sd">            &#39;der_weights&#39;: [[Variable(&#39;w0w1w2&#39;, width=7), Constant(0b0000000, width=7)],</span>
<span class="sd">                [Variable(&#39;w3&#39;, width=5), Constant(0b00000, width=5)]]}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">(</span><span class="n">vrepr</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="SkChFound"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.SkChFound">[docs]</a><span class="k">class</span> <span class="nc">SkChFound</span><span class="p">(</span><span class="n">ChFound</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent (non-symbolic) single-key characteristics found.</span>

<span class="sd">    See also `ChFound`.</span>

<span class="sd">    ::</span>

<span class="sd">        &gt;&gt;&gt; from arxpy.differential.difference import XorDiff</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.differential.characteristic import SingleKeyCh</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.smt.search import SearchSkCh</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.primitives import speck</span>
<span class="sd">        &gt;&gt;&gt; Speck32 = speck.get_Speck_instance(speck.SpeckInstance.speck_32_64)</span>
<span class="sd">        &gt;&gt;&gt; Speck32.set_rounds(1)</span>
<span class="sd">        &gt;&gt;&gt; ch = SingleKeyCh(Speck32, XorDiff)</span>
<span class="sd">        &gt;&gt;&gt; search_problem = SearchSkCh(ch)</span>
<span class="sd">        &gt;&gt;&gt; ch_found = search_problem.solve(0)</span>
<span class="sd">        &gt;&gt;&gt; ch_found.ch_weight</span>
<span class="sd">        0x0</span>
<span class="sd">        &gt;&gt;&gt; ch_found.der_weights</span>
<span class="sd">        [[w0, 0x0]]</span>
<span class="sd">        &gt;&gt;&gt; ch_found.input_diff  # doctest:+ELLIPSIS</span>
<span class="sd">        [[XorDiff(dp0), XorDiff(...)], [XorDiff(dp1), XorDiff(...)]]</span>
<span class="sd">        &gt;&gt;&gt; ch_found.nonlinear_diffs  # doctest:+ELLIPSIS</span>
<span class="sd">        [[XorDiff(dx1), XorDiff(...)]]</span>
<span class="sd">        &gt;&gt;&gt; ch_found.output_diff  # doctest:+ELLIPSIS</span>
<span class="sd">        [[XorDiff(dx2), XorDiff(...)], [XorDiff(dx4), XorDiff(...)]]</span>
<span class="sd">        &gt;&gt;&gt; print(ch_found)  # doctest:+ELLIPSIS</span>
<span class="sd">        {&#39;ch_weight&#39;: 0,</span>
<span class="sd">         &#39;der_weights&#39;: [[w0, 0]],</span>
<span class="sd">         &#39;exact_weight&#39;: 0,</span>
<span class="sd">         &#39;input_diff&#39;: [[dp0, ...], [dp1, ...]],</span>
<span class="sd">         &#39;nonlinear_diffs&#39;: [[dx1, ...]],</span>
<span class="sd">         &#39;output_diff&#39;: [[dx2, ...], [dx4, ...]]}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch_weight</span><span class="p">,</span> <span class="n">der_weights</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ch_weight</span><span class="p">,</span> <span class="n">der_weights</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cipher</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">_cipher</span>

<div class="viewcode-block" id="SkChFound.check_empirical_weight"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.SkChFound.check_empirical_weight">[docs]</a>    <span class="k">def</span> <span class="nf">check_empirical_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose_lvl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the exact weight of the model matches one weight of the empirical weight distribution.</span>

<span class="sd">        If the exact weight doesn&#39;t match, the exception `ExactWeightError` is raised.</span>

<span class="sd">        If ``filename`` is not ``None``, the output will be printed</span>
<span class="sd">        to the given file rather than the to stdout.</span>

<span class="sd">        The argument ``verbose_lvl`` can also take the values ``1`` and ``2`` for a</span>
<span class="sd">        more detailed output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_empirical_distribution_weight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cipher</span><span class="p">,</span> <span class="n">verbose_lvl</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">rk_dict_diffs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RkChFound"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.RkChFound">[docs]</a><span class="k">class</span> <span class="nc">RkChFound</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent (non-symbolic) related-key characteristics found.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        rkch: the associated symbolic `RelatedKeyCh`</span>
<span class="sd">        key_ch_found: a `ChFound` denoting the key schedule characteristic found</span>
<span class="sd">        enc_ch_found: a `ChFound` denoting the encryption characteristic found</span>

<span class="sd">    ::</span>

<span class="sd">        &gt;&gt;&gt; from arxpy.differential.difference import XorDiff</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.differential.characteristic import RelatedKeyCh</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.smt.search import SearchRkCh</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.primitives.lea import LeaCipher</span>
<span class="sd">        &gt;&gt;&gt; LeaCipher.set_rounds(1)</span>
<span class="sd">        &gt;&gt;&gt; rkch = RelatedKeyCh(LeaCipher, XorDiff)</span>
<span class="sd">        &gt;&gt;&gt; search_problem = SearchRkCh(rkch)</span>
<span class="sd">        &gt;&gt;&gt; rkch_found = search_problem.solve(0, 0, solver_name=&quot;btor&quot;)</span>
<span class="sd">        &gt;&gt;&gt; rkch_found.key_ch_found.ch_weight</span>
<span class="sd">        0b0000000</span>
<span class="sd">        &gt;&gt;&gt; rkch_found.key_ch_found.input_diff  # doctest: +ELLIPSIS,+NORMALIZE_WHITESPACE</span>
<span class="sd">        [[XorDiff(dmk0), XorDiff(...)], [XorDiff(dmk1), XorDiff(...)],</span>
<span class="sd">        [XorDiff(dmk2), XorDiff(...)], [XorDiff(dmk3), XorDiff(...)]]</span>
<span class="sd">        &gt;&gt;&gt; rkch_found.key_ch_found.output_diff  # doctest: +ELLIPSIS,+NORMALIZE_WHITESPACE</span>
<span class="sd">        [[XorDiff(dk1), XorDiff(...)], [XorDiff(dk3), XorDiff(...)],</span>
<span class="sd">        [XorDiff(dk5), XorDiff(...)], [XorDiff(dk3), XorDiff(...)],</span>
<span class="sd">        [XorDiff(dk7), XorDiff(...)], [XorDiff(dk3), XorDiff(...)]]</span>
<span class="sd">        &gt;&gt;&gt; rkch_found.enc_ch_found.ch_weight</span>
<span class="sd">        0b0000000</span>
<span class="sd">        &gt;&gt;&gt; rkch_found.enc_ch_found.input_diff  # doctest: +ELLIPSIS,+NORMALIZE_WHITESPACE</span>
<span class="sd">        [[XorDiff(dp0), XorDiff(...)], [XorDiff(dp1), XorDiff(...)],</span>
<span class="sd">        [XorDiff(dp2), XorDiff(...)], [XorDiff(dp3), XorDiff(...)]]</span>
<span class="sd">        &gt;&gt;&gt; rkch_found.enc_ch_found.output_diff  # doctest: +ELLIPSIS,+NORMALIZE_WHITESPACE</span>
<span class="sd">        [[XorDiff(dx3), XorDiff(...)], [XorDiff(dx7), XorDiff(...)],</span>
<span class="sd">        [XorDiff(dx11), XorDiff(...)], [XorDiff(dp0), XorDiff(...)]]</span>
<span class="sd">        &gt;&gt;&gt; print(rkch_found)  # doctest: +ELLIPSIS</span>
<span class="sd">        {&#39;enc_ch_found&#39;: {&#39;ch_weight&#39;: 0,</span>
<span class="sd">                          &#39;der_weights&#39;: [[w0w1w2, 0]],</span>
<span class="sd">                          &#39;exact_weight&#39;: 0,</span>
<span class="sd">                          &#39;input_diff&#39;: [[dp0, ...], [dp1, ...], [dp2, ...], [dp3, ...]],</span>
<span class="sd">                          &#39;nonlinear_diffs&#39;: [[dx2, ...], [dx6, ...], [dx10, ...]],</span>
<span class="sd">                          &#39;output_diff&#39;: [[dx3, ...], [dx7, ...], [dx11, ...], [dp0, ...]]},</span>
<span class="sd">         &#39;key_ch_found&#39;: {&#39;ch_weight&#39;: 0,</span>
<span class="sd">                          &#39;der_weights&#39;: [[wk0, ...], [wk1, ...], [wk2, ...], [wk3, ...]],</span>
<span class="sd">                          &#39;exact_weight&#39;: ...,</span>
<span class="sd">                          &#39;input_diff&#39;: [[dmk0, ...], [dmk1, ...], [dmk2, ...], [dmk3, ...]],</span>
<span class="sd">                          &#39;nonlinear_diffs&#39;: [[dk0, ...], [dk2, ...], [dk4, ...], [dk6, ...]],</span>
<span class="sd">                          &#39;output_diff&#39;: [[dk1, ...], [dk3, ...], [dk5, ...], [dk3, ...], [dk7, ...], [dk3, ...]]}}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rkch</span><span class="p">,</span> <span class="n">key_schedule_problem</span><span class="p">,</span> <span class="n">encryption_problem</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rkch</span> <span class="o">=</span> <span class="n">rkch</span>
        <span class="n">kp</span> <span class="o">=</span> <span class="n">key_schedule_problem</span>
        <span class="n">key_model</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="n">model</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">kp</span><span class="o">.</span><span class="n">der_weights</span> <span class="o">+</span> <span class="p">[</span><span class="n">kp</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">]}</span>  <span class="c1"># always present</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">kp</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">input_diff</span><span class="p">,</span> <span class="n">kp</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
                <span class="n">key_model</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_ch_found</span> <span class="o">=</span> <span class="n">ChFound</span><span class="p">(</span><span class="n">kp</span><span class="o">.</span><span class="n">ch</span><span class="p">,</span> <span class="n">kp</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">kp</span><span class="o">.</span><span class="n">der_weights</span><span class="p">,</span> <span class="n">key_model</span><span class="p">)</span>

        <span class="n">ep</span> <span class="o">=</span> <span class="n">encryption_problem</span>
        <span class="n">enc_model</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="n">model</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ep</span><span class="o">.</span><span class="n">der_weights</span> <span class="o">+</span> <span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">]}</span>  <span class="c1"># always present</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">input_diff</span><span class="p">,</span> <span class="n">ep</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
                <span class="n">enc_model</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enc_ch_found</span> <span class="o">=</span> <span class="n">ChFound</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">ch</span><span class="p">,</span> <span class="n">ep</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">ep</span><span class="o">.</span><span class="n">der_weights</span><span class="p">,</span> <span class="n">enc_model</span><span class="p">,</span>
                                    <span class="n">aux_model</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_ch_found</span><span class="o">.</span><span class="n">_diff_model</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cipher</span> <span class="o">=</span> <span class="n">rkch</span><span class="o">.</span><span class="n">_cipher</span>

    <span class="k">def</span> <span class="nf">signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch_signature_type</span><span class="p">,</span> <span class="n">return_str</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_ch_found</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">ch_signature_type</span><span class="p">,</span> <span class="n">return_str</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">enc_ch_found</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">ch_signature_type</span><span class="p">,</span> <span class="n">return_str</span><span class="p">)</span>

<div class="viewcode-block" id="RkChFound.check_empirical_weight"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.RkChFound.check_empirical_weight">[docs]</a>    <span class="k">def</span> <span class="nf">check_empirical_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose_lvl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the exact weight of the model match its empirical weight.</span>

<span class="sd">        Check both the exact weight of the key schedule characteristic</span>
<span class="sd">        and the encryption characteristic found match their</span>
<span class="sd">        empirical weights.</span>

<span class="sd">        See also `ChFound.check_empirical_weight` and `SkChFound.check_empirical_weight`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smart_print</span> <span class="o">=</span> <span class="n">_get_smart_print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># TODO: (v2) append all output_diff (both name and value) if variable missing in verification</span>
            <span class="n">output_diff</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">diff_name</span><span class="p">,</span> <span class="n">diff_expr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rkch</span><span class="o">.</span><span class="n">key_schedule_ch</span><span class="o">.</span><span class="n">output_diff</span><span class="p">):</span>
                <span class="n">output_diff</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">diff_expr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_ch_found</span><span class="o">.</span><span class="n">output_diff</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose_lvl</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Checking the weight of the key schedule characteristic&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_ch_found</span><span class="o">.</span><span class="n">check_empirical_weight</span><span class="p">(</span><span class="n">verbose_lvl</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">rk_dict_diffs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;nonlinear_diffs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_ch_found</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="p">,</span>
                <span class="s2">&quot;output_diff&quot;</span><span class="p">:</span> <span class="n">output_diff</span>
                <span class="c1"># &quot;output_diff&quot;: self.key_ch_found.output_diff</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">verbose_lvl</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Checking the weight of the encryption characteristic&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enc_ch_found</span><span class="o">.</span><span class="n">_check_empirical_distribution_weight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cipher</span><span class="p">,</span> <span class="n">verbose_lvl</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">rk_dict_diffs</span><span class="o">=</span><span class="n">rk_dict_diffs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ExactWeightError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span></div>

    <span class="k">def</span> <span class="nf">_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vrepr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">dict_ch</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;key_ch_found&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_ch_found</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">(</span><span class="n">vrepr</span><span class="o">=</span><span class="n">vrepr</span><span class="p">),</span>
            <span class="s2">&quot;enc_ch_found&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enc_ch_found</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">(</span><span class="n">vrepr</span><span class="o">=</span><span class="n">vrepr</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">dict_ch</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">(),</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="RkChFound.vrepr"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.RkChFound.vrepr">[docs]</a>    <span class="k">def</span> <span class="nf">vrepr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a verbose dictionary-like representation of the characteristic.</span>

<span class="sd">        See also `ChFound.vrepr`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">(</span><span class="n">vrepr</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="SearchCh"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.SearchCh">[docs]</a><span class="k">class</span> <span class="nc">SearchCh</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent the SMT problem of finding a `BvCharacteristic` with conditions on the weight.</span>

<span class="sd">    Args:</span>
<span class="sd">        ch (BvCharacteristic): a symbolic characteristic of a `BvFunction`</span>
<span class="sd">        der_mode (DerMode): one of the modes available for the derivative weights</span>
<span class="sd">        weight_prefix (str): the prefix to label weight variables</span>
<span class="sd">        allow_zero_input_diff(bool): if ``True``, allow the input difference to be zero</span>
<span class="sd">        initial_constraints (list): a list of constraints (given as `Term`) to add to the SMT problem</span>
<span class="sd">        env (pysmt.environment.Environment): if ``None``, a new pySMT environment is created</span>

<span class="sd">    ::</span>

<span class="sd">        &gt;&gt;&gt; from arxpy.bitvector.core import Variable</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.differential.difference import XorDiff</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.differential.characteristic import BvCharacteristic</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.primitives.chaskey import ChaskeyPi</span>
<span class="sd">        &gt;&gt;&gt; ChaskeyPi.set_rounds(1)</span>
<span class="sd">        &gt;&gt;&gt; ch = BvCharacteristic(ChaskeyPi, XorDiff, [&quot;dv0&quot;, &quot;dv1&quot;, &quot;dv2&quot;, &quot;dv3&quot;])</span>
<span class="sd">        &gt;&gt;&gt; search_problem = SearchCh(ch)</span>
<span class="sd">        &gt;&gt;&gt; search_problem.formula_size()</span>
<span class="sd">        2804</span>
<span class="sd">        &gt;&gt;&gt; search_problem.error()</span>
<span class="sd">        0</span>
<span class="sd">        &gt;&gt;&gt; print(search_problem.hrepr(False))</span>
<span class="sd">        assert ~(0x00000000000000000000000000000000 == (dv0 :: dv1 :: dv2 :: dv3))</span>
<span class="sd">        assert 0x00000000 == ((~(... &lt;&lt; ...) ^ (d0 &lt;&lt; 0x00000001)) &amp; (~(... &lt;&lt; ...) ^ (dv1 &lt;&lt; 0x00000001)) &amp; ((dv0 &lt;&lt; 0x00000001) ^ d0 ^ dv0 ^ dv1))</span>
<span class="sd">        assert 0x00000000 == ((~(... &lt;&lt; ...) ^ (d4 &lt;&lt; 0x00000001)) &amp; (~(... &lt;&lt; ...) ^ (dv3 &lt;&lt; 0x00000001)) &amp; ((dv2 &lt;&lt; 0x00000001) ^ d4 ^ dv2 ^ dv3))</span>
<span class="sd">        assert 0x00000000 == ((~(... &lt;&lt; ...) ^ (d7 &lt;&lt; 0x00000001)) &amp; (~(... &lt;&lt; ...) ^ ((... ^ ...) &lt;&lt; 0x00000001)) &amp; (((d0 &lt;&lt;&lt; 16) &lt;&lt; 0x00000001) ^ d7 ^ ... ^ ... ^ (... &lt;&lt;&lt; ...)))</span>
<span class="sd">        assert 0x00000000 == ((~(... &lt;&lt; ...) ^ (d10 &lt;&lt; 0x00000001)) &amp; (~(... &lt;&lt; ...) ^ (d4 &lt;&lt; 0x00000001)) &amp; (((d0 ^ (... &lt;&lt;&lt; ...)) &lt;&lt; 0x00000001) ^ d10 ^ d4 ^ ... ^ ...))</span>
<span class="sd">        assert w0w1w2 == (PopCountSum3(~((d0 ^ ~...) &amp; (dv1 ^ ~...))[30:], ~((d4 ^ ~...) &amp; (dv3 ^ ~...))[30:], ~((d7 ^ ~...) &amp; (~... ^ ... ^ ...))[30:]))</span>
<span class="sd">        assert w3 == PopCount(~((d10 ^ ~...) &amp; (d4 ^ ~...))[30:])</span>
<span class="sd">        assert w == (w0w1w2 + (0b00 :: w3))</span>
<span class="sd">        minimize w</span>
<span class="sd">        &gt;&gt;&gt; search_problem.solve(0).ch_weight</span>
<span class="sd">        0b0000000</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">der_mode</span><span class="o">=</span><span class="n">DerMode</span><span class="o">.</span><span class="n">Default</span><span class="p">,</span> <span class="n">weight_prefix</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
                 <span class="n">allow_zero_input_diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initial_constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">BvCharacteristic</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">der_mode</span><span class="p">,</span> <span class="n">DerMode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">der_mode</span> <span class="o">==</span> <span class="n">DerMode</span><span class="o">.</span><span class="n">XDCA_Approx</span><span class="p">:</span>
            <span class="k">class</span> <span class="nc">XDCA_Approx</span><span class="p">(</span><span class="n">derivative</span><span class="o">.</span><span class="n">XDCA</span><span class="p">):</span>
                <span class="n">precision</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">diff</span> <span class="ow">in</span> <span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="p">:</span>
                <span class="n">der</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="p">[</span><span class="n">diff</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">der</span><span class="p">,</span> <span class="n">derivative</span><span class="o">.</span><span class="n">XDCA</span><span class="p">):</span>
                    <span class="n">der</span> <span class="o">=</span> <span class="n">XDCA_Approx</span><span class="p">(</span><span class="n">der</span><span class="o">.</span><span class="n">input_diff</span><span class="p">,</span> <span class="n">der</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">constant</span><span class="p">)</span>
                    <span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="p">[</span><span class="n">diff</span><span class="p">]</span> <span class="o">=</span> <span class="n">der</span>
                    <span class="k">assert</span> <span class="n">der</span><span class="o">.</span><span class="n">precision</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">initial_constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="n">initial_constraints</span><span class="p">[:]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_zero_input_diff</span><span class="p">:</span>
            <span class="n">input_diff</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">Concat</span><span class="p">,</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ch</span><span class="o">.</span><span class="n">input_diff</span><span class="p">])</span>
            <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">BvNot</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">input_diff</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">input_diff</span><span class="o">.</span><span class="n">width</span><span class="p">))))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_prefix</span> <span class="o">=</span> <span class="n">weight_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">der_mode</span> <span class="o">=</span> <span class="n">der_mode</span>

        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">NotEvaluation</span><span class="p">([</span><span class="n">extraop</span><span class="o">.</span><span class="n">Reverse</span><span class="p">,</span> <span class="n">extraop</span><span class="o">.</span><span class="n">LeadingZeros</span><span class="p">,</span>
                                    <span class="n">extraop</span><span class="o">.</span><span class="n">PopCount</span><span class="p">,</span> <span class="n">extraop</span><span class="o">.</span><span class="n">PopCountDiff</span><span class="p">,</span> <span class="n">extraop</span><span class="o">.</span><span class="n">PopCountSum2</span><span class="p">,</span> <span class="n">extraop</span><span class="o">.</span><span class="n">PopCountSum3</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_constraints</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">reset_env</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_generate_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate the bit-vector constraints of the SMT problem.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="p">:</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ch_weight</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_prefix</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ch_weight</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">=</span> <span class="n">ch_weight</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">der_weights</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ch_max_weight</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">der_mode</span> <span class="o">==</span> <span class="n">DerMode</span><span class="o">.</span><span class="n">ProbabilityOne</span><span class="p">:</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">der</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">der</span><span class="o">.</span><span class="n">has_probability_one</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>

            <span class="n">ch_weight</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_prefix</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ch_weight</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">=</span> <span class="n">ch_weight</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">der_weights</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ch_max_weight</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">der_mode</span> <span class="o">==</span> <span class="n">DerMode</span><span class="o">.</span><span class="n">Valid</span><span class="p">:</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">der</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">der</span><span class="o">.</span><span class="n">is_possible</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>

            <span class="n">ch_weight</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_prefix</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ch_weight</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">=</span> <span class="n">ch_weight</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">der_weights</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ch_max_weight</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span>

        <span class="n">max_num_frac_bits</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">der</span><span class="o">.</span><span class="n">num_frac_bits</span><span class="p">()</span> <span class="k">for</span> <span class="n">der</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">ch_max_weight</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">der</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ch_max_weight</span> <span class="o">+=</span> <span class="n">der</span><span class="o">.</span><span class="n">max_weight</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">max_num_frac_bits</span> <span class="o">-</span> <span class="n">der</span><span class="o">.</span><span class="n">num_frac_bits</span><span class="p">())</span>
        <span class="n">ch_max_weight</span> <span class="o">=</span> <span class="n">ch_max_weight</span> <span class="o">&gt;&gt;</span> <span class="n">max_num_frac_bits</span>   <span class="c1"># ch_weight ignore fraction bits</span>
        <span class="n">ch_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ch_max_weight</span><span class="o">.</span><span class="n">bit_length</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">diff</span><span class="p">,</span> <span class="n">der</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">der</span><span class="p">,</span> <span class="n">derivative</span><span class="o">.</span><span class="n">XDCA</span><span class="p">):</span>
                <span class="c1"># the width of XDAC.weight is &quot;greater&quot; than its max_weight</span>
                <span class="c1"># (the MSB bits of XDAC.weight are not used)</span>
                <span class="n">int_width</span> <span class="o">=</span> <span class="n">der</span><span class="o">.</span><span class="n">weight</span><span class="p">(</span><span class="n">diff</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">der</span><span class="o">.</span><span class="n">num_frac_bits</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">int_width</span> <span class="o">=</span> <span class="n">der</span><span class="o">.</span><span class="n">weight</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">der</span><span class="o">.</span><span class="n">num_frac_bits</span><span class="p">()</span>
            <span class="n">ch_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ch_width</span><span class="p">,</span> <span class="n">int_width</span><span class="p">)</span>

        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># fb2width2hw is a dictionary mapping frac_bits -&gt; input_width -&gt; (weight_var, PopCount)</span>
        <span class="c1"># note only PopCounts with the same number of frac_bits and similar args are grouped together</span>
        <span class="n">fb2width2hw</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">original_der_weights</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">der_weights</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">zero_ext_right</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">num_zeros</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Expand with zeros to the right.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">num_zeros</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">var</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">operation</span><span class="o">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_zeros</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">der</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">der</span><span class="o">.</span><span class="n">is_possible</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">der</span><span class="p">,</span> <span class="n">derivative</span><span class="o">.</span><span class="n">XDCA</span><span class="p">):</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_prefix</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_tmp&quot;</span>
                <span class="c1"># with context.NotEvaluation(extraop.PopCount):</span>
                <span class="k">assert</span> <span class="n">extraop</span><span class="o">.</span><span class="n">PopCount</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">NotEvaluation</span><span class="o">.</span><span class="n">current_context</span>
                <span class="n">weight_value</span> <span class="o">=</span> <span class="n">der</span><span class="o">.</span><span class="n">weight</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weight_value</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">weight_value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
                    <span class="n">weight_value</span><span class="p">,</span> <span class="n">assertions</span> <span class="o">=</span> <span class="n">weight_value</span>
                    <span class="n">weight_var</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_prefix</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">weight_value</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
                    <span class="n">constraints</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">assertions</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># with context.NotEvaluation(extraop.PopCount):</span>
                <span class="k">assert</span> <span class="n">extraop</span><span class="o">.</span><span class="n">PopCount</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">NotEvaluation</span><span class="o">.</span><span class="n">current_context</span>
                <span class="n">weight_value</span> <span class="o">=</span> <span class="n">der</span><span class="o">.</span><span class="n">weight</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
                <span class="n">weight_var</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_prefix</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">weight_value</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">weight_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">num_fb</span> <span class="o">=</span> <span class="n">der</span><span class="o">.</span><span class="n">num_frac_bits</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weight_value</span><span class="p">,</span> <span class="n">extraop</span><span class="o">.</span><span class="n">PopCount</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">num_fb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fb2width2hw</span><span class="p">:</span>
                    <span class="n">fb2width2hw</span><span class="p">[</span><span class="n">num_fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">input_hw_width</span> <span class="o">=</span> <span class="n">weight_value</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span>
                <span class="k">if</span> <span class="n">input_hw_width</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fb2width2hw</span><span class="p">[</span><span class="n">num_fb</span><span class="p">]:</span>
                    <span class="n">fb2width2hw</span><span class="p">[</span><span class="n">num_fb</span><span class="p">][</span><span class="n">input_hw_width</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">fb2width2hw</span><span class="p">[</span><span class="n">num_fb</span><span class="p">][</span><span class="n">input_hw_width</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">weight_var</span><span class="p">,</span> <span class="n">weight_value</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">weight_var</span><span class="p">,</span> <span class="n">weight_value</span><span class="p">))</span>
                <span class="n">original_der_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight_var</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">ch_width</span> <span class="o">&gt;=</span> <span class="n">weight_var</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">der</span><span class="o">.</span><span class="n">num_frac_bits</span><span class="p">()</span>  <span class="c1"># der_int_width</span>
                <span class="n">weight_var</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">ZeroExtend</span><span class="p">(</span><span class="n">weight_var</span><span class="p">,</span> <span class="n">ch_width</span> <span class="o">-</span> <span class="p">(</span><span class="n">weight_var</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">der</span><span class="o">.</span><span class="n">num_frac_bits</span><span class="p">()))</span>
                <span class="n">weight_var</span> <span class="o">=</span> <span class="n">zero_ext_right</span><span class="p">(</span><span class="n">weight_var</span><span class="p">,</span> <span class="n">max_num_frac_bits</span> <span class="o">-</span> <span class="n">der</span><span class="o">.</span><span class="n">num_frac_bits</span><span class="p">())</span>
                <span class="n">der_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight_var</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">grouped</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Group iterable in packs of n elements.</span>

<span class="sd">            If len(iterable) % n != 0, the last elements are not included.</span>
<span class="sd">            Example: grouped([s0,s1,s2,s3,s4], 2) -&gt; ((s0, s1), (s2, s3))</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">num_fb</span> <span class="ow">in</span> <span class="n">fb2width2hw</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">weightvar_hwvalue_pairs</span> <span class="ow">in</span> <span class="n">fb2width2hw</span><span class="p">[</span><span class="n">num_fb</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="p">((</span><span class="n">w1</span><span class="p">,</span> <span class="n">p1</span><span class="p">),</span> <span class="p">(</span><span class="n">w2</span><span class="p">,</span> <span class="n">p2</span><span class="p">),</span> <span class="p">(</span><span class="n">w3</span><span class="p">,</span> <span class="n">p3</span><span class="p">))</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">(</span><span class="n">weightvar_hwvalue_pairs</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">p1</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">p2</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">p3</span><span class="o">.</span><span class="n">width</span>
                    <span class="n">weight_value</span> <span class="o">=</span> <span class="n">extraop</span><span class="o">.</span><span class="n">PopCountSum3</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p3</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">weight_var</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">w1</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">w2</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">w3</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">weight_value</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
                    <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">weight_var</span><span class="p">,</span> <span class="n">weight_value</span><span class="p">))</span>
                    <span class="n">original_der_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight_var</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">ch_width</span> <span class="o">&gt;=</span> <span class="n">weight_var</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">num_fb</span>
                    <span class="n">weight_var</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">ZeroExtend</span><span class="p">(</span><span class="n">weight_var</span><span class="p">,</span> <span class="n">ch_width</span> <span class="o">-</span> <span class="p">(</span><span class="n">weight_var</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">num_fb</span><span class="p">))</span>
                    <span class="n">weight_var</span> <span class="o">=</span> <span class="n">zero_ext_right</span><span class="p">(</span><span class="n">weight_var</span><span class="p">,</span> <span class="n">max_num_frac_bits</span> <span class="o">-</span> <span class="n">num_fb</span><span class="p">)</span>
                    <span class="n">der_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight_var</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weightvar_hwvalue_pairs</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">w1</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">weightvar_hwvalue_pairs</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">w2</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">weightvar_hwvalue_pairs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="n">p1</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">p2</span><span class="o">.</span><span class="n">width</span>
                    <span class="n">weight_value</span> <span class="o">=</span> <span class="n">extraop</span><span class="o">.</span><span class="n">PopCountSum2</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">weight_var</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">w1</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">w2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">weight_value</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
                    <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">weight_var</span><span class="p">,</span> <span class="n">weight_value</span><span class="p">))</span>
                    <span class="n">original_der_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight_var</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">ch_width</span> <span class="o">&gt;=</span> <span class="n">weight_var</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">num_fb</span>
                    <span class="n">weight_var</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">ZeroExtend</span><span class="p">(</span><span class="n">weight_var</span><span class="p">,</span> <span class="n">ch_width</span> <span class="o">-</span> <span class="p">(</span><span class="n">weight_var</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">num_fb</span><span class="p">))</span>
                    <span class="n">weight_var</span> <span class="o">=</span> <span class="n">zero_ext_right</span><span class="p">(</span><span class="n">weight_var</span><span class="p">,</span> <span class="n">max_num_frac_bits</span> <span class="o">-</span> <span class="n">num_fb</span><span class="p">)</span>
                    <span class="n">der_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight_var</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">weightvar_hwvalue_pairs</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">w1</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">weightvar_hwvalue_pairs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">weight_var</span> <span class="o">=</span> <span class="n">w1</span>
                    <span class="n">weight_value</span> <span class="o">=</span> <span class="n">p1</span>
                    <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">weight_var</span><span class="p">,</span> <span class="n">weight_value</span><span class="p">))</span>
                    <span class="n">original_der_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight_var</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">ch_width</span> <span class="o">&gt;=</span> <span class="n">weight_var</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">num_fb</span>
                    <span class="n">weight_var</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">ZeroExtend</span><span class="p">(</span><span class="n">weight_var</span><span class="p">,</span> <span class="n">ch_width</span> <span class="o">-</span> <span class="p">(</span><span class="n">weight_var</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">num_fb</span><span class="p">))</span>
                    <span class="n">weight_var</span> <span class="o">=</span> <span class="n">zero_ext_right</span><span class="p">(</span><span class="n">weight_var</span><span class="p">,</span> <span class="n">max_num_frac_bits</span> <span class="o">-</span> <span class="n">num_fb</span><span class="p">)</span>
                    <span class="n">der_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight_var</span><span class="p">)</span>

        <span class="c1"># value of the characteristic weight</span>
        <span class="n">sum_w</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">der_weights</span><span class="p">)[:</span><span class="n">max_num_frac_bits</span><span class="p">]</span>
        <span class="n">ch_weight</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_prefix</span><span class="p">,</span> <span class="n">sum_w</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">sum_w</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">=</span> <span class="n">ch_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ch_max_weight</span> <span class="o">=</span> <span class="n">ch_max_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">der_weights</span> <span class="o">=</span> <span class="n">original_der_weights</span>

<div class="viewcode-block" id="SearchCh.solve"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.SearchCh.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_weight</span><span class="p">,</span> <span class="n">solver_name</span><span class="o">=</span><span class="s2">&quot;btor&quot;</span><span class="p">,</span> <span class="n">search_mode</span><span class="o">=</span><span class="n">ChSearchMode</span><span class="o">.</span><span class="n">Optimal</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">return_generator</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Solve the SMT problem associated to the search of a valid `BvCharacteristic`.</span>

<span class="sd">        Args:</span>
<span class="sd">             initial_weight(int): the initial weight for starting the iterative search</span>
<span class="sd">             solver_name(str): the name of the solver (according to pySMT) to be used</span>
<span class="sd">             search_mode(ChSearchMode): one of the search modes available</span>
<span class="sd">             check(bool): if ``True``, `ChFound.check_empirical_weight` will be called</span>
<span class="sd">                after a characteristic is found. If it is not valid, the search will continue.</span>
<span class="sd">             return_generator(bool): if ``True``, return a Python generator with the</span>
<span class="sd">                characteristics found (only valid in AllOptimal)</span>
<span class="sd">             verbose_level(int): an integer between ``0`` (no verbose) and ``3`` (full verbose).</span>
<span class="sd">             filename(str): if not ``None``, the output will be  printed to the given file</span>
<span class="sd">                rather than the to stdout.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">initial_weight</span> <span class="o">&lt;</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">input_widths</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">SearchCh</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">search_mode</span><span class="p">,</span> <span class="n">ChSearchMode</span><span class="p">)</span>

        <span class="c1"># don&#39;t merge incremental_solve() in solve() to allow different</span>
        <span class="c1"># ways of solving in the future</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incremental_solve</span><span class="p">(</span><span class="n">initial_weight</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">,</span> <span class="n">search_mode</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">return_generator</span><span class="p">,</span>
                                       <span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_incremental_solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_weight</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">,</span> <span class="n">search_mode</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">return_generator</span><span class="p">,</span>
                           <span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">strict_shift</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">solver_name</span> <span class="o">==</span> <span class="s2">&quot;btor&quot;</span> <span class="k">else</span> <span class="kc">False</span>  <span class="c1"># e.g., btor_rol: width must be a power of 2</span>
        <span class="n">bv2pysmt</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">bv2pysmt</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">,</span> <span class="n">strict_shift</span><span class="o">=</span><span class="n">strict_shift</span><span class="p">)</span>

        <span class="n">smart_print</span> <span class="o">=</span> <span class="n">_get_smart_print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">differences_in_model</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">input_diff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">differences_in_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">SearchCh</span><span class="p">:</span>
            <span class="n">search_mode_class</span> <span class="o">=</span> <span class="n">ChSearchMode</span>
            <span class="n">ch_found_class</span> <span class="o">=</span> <span class="n">ChFound</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">SearchSkCh</span><span class="p">:</span>
            <span class="n">search_mode_class</span> <span class="o">=</span> <span class="n">SkChSearchMode</span>
            <span class="n">ch_found_class</span> <span class="o">=</span> <span class="n">SkChFound</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid subclass of SearchCh&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_generator</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">search_mode_class</span><span class="o">.</span><span class="n">AllOptimal</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;return_generator can only be enabled with the search mode AllOptimal&quot;</span><span class="p">)</span>

        <span class="c1"># with self._env.factory.Solver(name=solver_name, logic=logics.QF_BV) as solver:</span>
        <span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">Solver</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">solver_name</span><span class="p">,</span> <span class="n">logic</span><span class="o">=</span><span class="n">logics</span><span class="o">.</span><span class="n">QF_BV</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="n">max_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">()</span>
        <span class="n">orig_upper_bound</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">input_widths</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">max_error</span><span class="p">)</span>  <span class="c1"># strict upper bound</span>
        <span class="n">upper_bound</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">orig_upper_bound</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_max_weight</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Upper bound: </span><span class="si">{}</span><span class="s2">, max error: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">max_error</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">search_mode_class</span><span class="o">.</span><span class="n">FirstCh</span><span class="p">:</span>
            <span class="n">target_weight</span> <span class="o">=</span> <span class="n">initial_weight</span>

            <span class="k">while</span> <span class="n">target_weight</span> <span class="o">&lt;</span> <span class="n">upper_bound</span><span class="p">:</span>
                <span class="n">eq_weight</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">target_weight</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Solving&quot;</span><span class="p">,</span> <span class="n">eq_weight</span><span class="p">)</span>
                <span class="n">satisfiable</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">([</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">eq_weight</span><span class="p">,</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span>

                <span class="k">if</span> <span class="n">satisfiable</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">pysmt_model2bv_model</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">get_model</span><span class="p">(),</span> <span class="n">differences_in_model</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">model</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_weight</span>

                    <span class="n">ch_found</span> <span class="o">=</span> <span class="n">ch_found_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">der_weights</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ch_found</span><span class="o">.</span><span class="n">check_empirical_weight</span><span class="p">(</span><span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">ExactWeightError</span><span class="p">:</span>
                            <span class="n">ch_found</span><span class="o">.</span><span class="n">emp_weight</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>

                    <span class="n">solver</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">ch_found</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">target_weight</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Unsatisfiable&quot;</span><span class="p">)</span>

                <span class="n">solver</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">search_mode_class</span><span class="o">.</span><span class="n">AllValid</span><span class="p">:</span>
            <span class="n">last_ch_found</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ch_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">characteristic</span><span class="o">.</span><span class="n">ChSignatureType</span><span class="o">.</span><span class="n">Full</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">orig_upper_bound</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_max_weight</span><span class="p">:</span>
                <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">&lt;</span> <span class="n">orig_upper_bound</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Added assertion:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">&lt;</span> <span class="n">orig_upper_bound</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">MAX_CH_FOUND</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">last_ch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">candidate_sig</span> <span class="o">=</span> <span class="n">last_ch_found</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">characteristic</span><span class="o">.</span><span class="n">ChSignatureType</span><span class="o">.</span><span class="n">Full</span><span class="p">)</span>
                    <span class="c1"># disable simplification due to recursion error</span>
                    <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">Simplification</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="o">~</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ch_sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">candidate_sig</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch_sig</span><span class="p">)):</span>
                            <span class="n">c</span> <span class="o">|=</span> <span class="o">~</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ch_sig</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">candidate_sig</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Added assertion:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Solving&quot;</span><span class="p">)</span>
                <span class="n">satisfiable</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">satisfiable</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">pysmt_model2bv_model</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">get_model</span><span class="p">(),</span> <span class="n">differences_in_model</span><span class="p">)</span>
                    <span class="n">last_ch_found</span> <span class="o">=</span> <span class="n">ch_found_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">der_weights</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

                    <span class="n">valid_ch</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">last_ch_found</span><span class="o">.</span><span class="n">check_empirical_weight</span><span class="p">(</span><span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">ExactWeightError</span><span class="p">:</span>
                            <span class="n">valid_ch</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Found invalid characteristic&quot;</span><span class="p">)</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="n">last_ch_found</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                                    <span class="n">smart_print</span><span class="p">(</span><span class="n">last_ch_found</span><span class="o">.</span><span class="n">vrepr</span><span class="p">())</span>

                    <span class="k">if</span> <span class="n">valid_ch</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Found characteristic&quot;</span><span class="p">)</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="n">last_ch_found</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="n">last_ch_found</span><span class="o">.</span><span class="n">vrepr</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">last_ch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| No more characteristics found&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| No characteristic found&quot;</span><span class="p">)</span>
                        <span class="n">smart_print</span><span class="p">()</span>
                    <span class="n">solver</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                    <span class="k">return</span>

        <span class="k">if</span> <span class="n">search_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">search_mode_class</span><span class="o">.</span><span class="n">Optimal</span><span class="p">,</span> <span class="n">search_mode_class</span><span class="o">.</span><span class="n">OptimalDifferential</span><span class="p">,</span>
                           <span class="n">search_mode_class</span><span class="o">.</span><span class="n">FirstChValid</span><span class="p">,</span> <span class="n">search_mode_class</span><span class="o">.</span><span class="n">AllOptimal</span><span class="p">]:</span>
            <span class="k">def</span> <span class="nf">iterate_ch</span><span class="p">(</span><span class="n">upper_bound</span><span class="p">):</span>
                <span class="n">solver</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>

                <span class="n">min_exact_weight</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>
                <span class="n">last_ch_found</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">best_ch_found</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">target_weight</span> <span class="o">=</span> <span class="n">initial_weight</span>

                <span class="k">if</span> <span class="n">search_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">search_mode_class</span><span class="o">.</span><span class="n">Optimal</span><span class="p">,</span> <span class="n">search_mode_class</span><span class="o">.</span><span class="n">AllOptimal</span><span class="p">]:</span>
                    <span class="n">signature_type</span> <span class="o">=</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">ChSignatureType</span><span class="o">.</span><span class="n">Full</span>
                <span class="k">elif</span> <span class="n">search_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">search_mode_class</span><span class="o">.</span><span class="n">FirstChValid</span><span class="p">,</span> <span class="n">search_mode_class</span><span class="o">.</span><span class="n">OptimalDifferential</span><span class="p">]:</span>
                    <span class="n">signature_type</span> <span class="o">=</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">ChSignatureType</span><span class="o">.</span><span class="n">InputOutput</span>

                <span class="n">ch_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">signature_type</span><span class="p">)</span>

                <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span>
                    <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">target_weight</span><span class="p">),</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

                <span class="k">while</span> <span class="n">target_weight</span> <span class="o">&lt;</span> <span class="n">upper_bound</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">last_ch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">candidate_sig</span> <span class="o">=</span> <span class="n">last_ch_found</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">signature_type</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_sig</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="o">~</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ch_sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">candidate_sig</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch_sig</span><span class="p">)):</span>
                            <span class="n">c</span> <span class="o">|=</span> <span class="o">~</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ch_sig</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">candidate_sig</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Added assertion:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Solving&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">target_weight</span><span class="p">))</span>

                    <span class="n">satisfiable</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">satisfiable</span><span class="p">:</span>
                        <span class="n">model</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">pysmt_model2bv_model</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">get_model</span><span class="p">(),</span> <span class="n">differences_in_model</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">model</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_weight</span>
                        <span class="n">last_ch_found</span> <span class="o">=</span> <span class="n">ch_found_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">der_weights</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

                        <span class="n">exact_weight</span> <span class="o">=</span> <span class="n">last_ch_found</span><span class="o">.</span><span class="n">get_exact_weight</span><span class="p">()</span>

                        <span class="n">valid_ch</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="n">exact_weight</span> <span class="o">&lt;</span> <span class="n">min_exact_weight</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">last_ch_found</span><span class="o">.</span><span class="n">check_empirical_weight</span><span class="p">(</span><span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                                <span class="k">except</span> <span class="n">ExactWeightError</span><span class="p">:</span>
                                    <span class="n">valid_ch</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Found invalid characteristic&quot;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                                            <span class="n">smart_print</span><span class="p">(</span><span class="n">last_ch_found</span><span class="o">.</span><span class="n">vrepr</span><span class="p">())</span>

                            <span class="k">if</span> <span class="n">valid_ch</span><span class="p">:</span>
                                <span class="n">best_ch_found</span> <span class="o">=</span> <span class="n">last_ch_found</span>
                                <span class="n">min_exact_weight</span> <span class="o">=</span> <span class="n">exact_weight</span>
                                <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Found better characteristic&quot;</span><span class="p">)</span>
                                    <span class="n">smart_print</span><span class="p">(</span><span class="n">last_ch_found</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                                        <span class="n">smart_print</span><span class="p">(</span><span class="n">last_ch_found</span><span class="o">.</span><span class="n">vrepr</span><span class="p">())</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Found worse characteristic (not checked)&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                                    <span class="n">smart_print</span><span class="p">(</span><span class="n">last_ch_found</span><span class="o">.</span><span class="n">vrepr</span><span class="p">())</span>

                        <span class="k">if</span> <span class="n">valid_ch</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">return_generator</span><span class="p">:</span>
                                <span class="k">yield</span> <span class="n">last_ch_found</span>
                            <span class="k">elif</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">search_mode_class</span><span class="o">.</span><span class="n">FirstChValid</span><span class="p">:</span>
                                <span class="n">solver</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                                <span class="k">return</span> <span class="n">last_ch_found</span>
                            <span class="k">elif</span> <span class="n">search_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">search_mode_class</span><span class="o">.</span><span class="n">Optimal</span><span class="p">,</span> <span class="n">search_mode_class</span><span class="o">.</span><span class="n">OptimalDifferential</span><span class="p">]:</span>
                                <span class="n">new_upper_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_upper_bound</span><span class="p">(</span><span class="n">last_ch_found</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">exact_weight</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">target_weight</span> <span class="o">&gt;=</span> <span class="n">new_upper_bound</span><span class="p">:</span>
                                    <span class="k">break</span>
                                <span class="k">if</span> <span class="n">new_upper_bound</span> <span class="o">!=</span> <span class="n">upper_bound</span> <span class="ow">and</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;New upper bound:&quot;</span><span class="p">,</span> <span class="n">new_upper_bound</span><span class="p">)</span>
                                <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">new_upper_bound</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">last_ch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| No more characteristics found&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| No characteristic found&quot;</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">last_ch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Removed assertions&quot;</span><span class="p">)</span>

                            <span class="n">smart_print</span><span class="p">()</span>

                        <span class="n">solver</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

                        <span class="n">target_weight</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">last_ch_found</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">solver</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
                        <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span>
                            <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">target_weight</span><span class="p">),</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

                <span class="n">solver</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">best_ch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">best_ch_found</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| No valid characteristic found&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="k">if</span> <span class="n">return_generator</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">iterate_ch</span><span class="p">(</span><span class="n">upper_bound</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">next</span><span class="p">(</span><span class="n">iterate_ch</span><span class="p">(</span><span class="n">upper_bound</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">solver</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">value</span>

        <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">search_mode_class</span><span class="o">.</span><span class="n">TopDifferentials</span><span class="p">:</span>
            <span class="n">index_ch_found</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">diff2weight</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">topdiff</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">diff2weight</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:</span><span class="mi">10</span><span class="p">])</span>

            <span class="k">def</span> <span class="nf">sum_weights</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="n">w1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">w0</span> <span class="o">==</span> <span class="n">w1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">w0</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">w0</span> <span class="o">-</span> <span class="mi">1</span>

                <span class="c1"># return - math.log2(2**(-w0) + 2**(-w1))</span>

                <span class="c1"># a &lt; b</span>
                <span class="c1"># 2^(-a) + 2^(-b) = 1/2^a + 1/2^b = 2^(b-a)/2^(b) + 1/2^b</span>
                <span class="c1">#                 = (2^(b-a) + 1) / 2^b</span>
                <span class="c1"># -log2(2^(-a) + 2^(-b)) = (-1) * (log2(2^(b-a) + 1) - b)</span>
                <span class="k">if</span> <span class="n">w0</span> <span class="o">&lt;</span> <span class="n">w1</span><span class="p">:</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">w0</span><span class="p">,</span> <span class="n">w1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OverflowError</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ln</span><span class="p">()</span><span class="o">/</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">ln</span><span class="p">()</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>

            <span class="n">solver</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>

            <span class="n">min_exact_weight</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">last_ch_found</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">best_ch_found</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">target_weight</span> <span class="o">=</span> <span class="n">initial_weight</span>

            <span class="n">signature_type</span> <span class="o">=</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">ChSignatureType</span><span class="o">.</span><span class="n">InputOutput</span>

            <span class="n">ch_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">signature_type</span><span class="p">)</span>

            <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span>
                <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">target_weight</span><span class="p">),</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="k">while</span> <span class="n">target_weight</span> <span class="o">&lt;</span> <span class="n">upper_bound</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">last_ch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">candidate_sig</span> <span class="o">=</span> <span class="n">last_ch_found</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">signature_type</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_sig</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="o">~</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ch_sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">candidate_sig</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch_sig</span><span class="p">)):</span>
                        <span class="n">c</span> <span class="o">|=</span> <span class="o">~</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ch_sig</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">candidate_sig</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Added assertion:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">last_ch_found</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># only print the target_weight for the 1st characteristic</span>
                    <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Solving&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">target_weight</span><span class="p">))</span>

                <span class="n">satisfiable</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">satisfiable</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">pysmt_model2bv_model</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">get_model</span><span class="p">(),</span> <span class="n">differences_in_model</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">model</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_weight</span>
                    <span class="n">last_ch_found</span> <span class="o">=</span> <span class="n">ch_found_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">der_weights</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

                    <span class="n">index_ch_found</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">exact_weight</span> <span class="o">=</span> <span class="n">last_ch_found</span><span class="o">.</span><span class="n">get_exact_weight</span><span class="p">()</span>

                    <span class="n">valid_ch</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">last_ch_found</span><span class="o">.</span><span class="n">check_empirical_weight</span><span class="p">(</span><span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">ExactWeightError</span><span class="p">:</span>
                            <span class="n">valid_ch</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Found invalid characteristic&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                                    <span class="n">smart_print</span><span class="p">(</span><span class="n">last_ch_found</span><span class="o">.</span><span class="n">vrepr</span><span class="p">())</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ch</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">exact_weight</span> <span class="o">&lt;</span> <span class="n">min_exact_weight</span><span class="p">:</span>
                        <span class="n">best_ch_found</span> <span class="o">=</span> <span class="n">last_ch_found</span>
                        <span class="n">min_exact_weight</span> <span class="o">=</span> <span class="n">exact_weight</span>
                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Found better characteristic&quot;</span><span class="p">)</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="n">last_ch_found</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="n">last_ch_found</span><span class="o">.</span><span class="n">vrepr</span><span class="p">())</span>

                    <span class="n">input_diff</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">last_ch_found</span><span class="o">.</span><span class="n">input_diff</span><span class="p">]</span>
                    <span class="n">output_diff</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">last_ch_found</span><span class="o">.</span><span class="n">output_diff</span><span class="p">]</span>
                    <span class="n">in_out_diff</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">input_diff</span> <span class="o">+</span> <span class="n">output_diff</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">in_out_diff</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff2weight</span><span class="p">:</span>
                        <span class="n">diff2weight</span><span class="p">[</span><span class="n">in_out_diff</span><span class="p">]</span> <span class="o">=</span> <span class="n">exact_weight</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">diff2weight</span><span class="p">[</span><span class="n">in_out_diff</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_weights</span><span class="p">(</span><span class="n">diff2weight</span><span class="p">[</span><span class="n">in_out_diff</span><span class="p">],</span> <span class="n">exact_weight</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;diff </span><span class="si">{}</span><span class="s2"> | sum_weights(</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">) = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">in_out_diff</span><span class="p">,</span>
                                <span class="n">diff2weight</span><span class="p">[</span><span class="n">in_out_diff</span><span class="p">],</span>
                                <span class="n">exact_weight</span><span class="p">,</span>
                                <span class="n">sum_weights</span><span class="p">(</span><span class="n">diff2weight</span><span class="p">[</span><span class="n">in_out_diff</span><span class="p">],</span> <span class="n">exact_weight</span><span class="p">)</span>
                            <span class="p">))</span>

                    <span class="c1"># TODO: (v2) store dictionary in folder</span>

                    <span class="n">newtopdiff</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">diff2weight</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:</span><span class="mi">10</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_ch_found</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">index_ch_found</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Found 2^</span><span class="si">{}</span><span class="s2"> characteristics&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">index_ch_found</span><span class="p">))))</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">topdiff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">9</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">newtopdiff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| First top 10 differentials&quot;</span><span class="p">)</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="n">newtopdiff</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">newtopdiff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">newtopdiff</span> <span class="o">!=</span> <span class="n">topdiff</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">differing</span> <span class="o">=</span> <span class="p">[</span><span class="n">i_d</span> <span class="k">for</span> <span class="n">i_d</span><span class="p">,</span> <span class="p">(</span><span class="n">old_d</span><span class="p">,</span> <span class="n">new_d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">topdiff</span><span class="p">,</span> <span class="n">newtopdiff</span><span class="p">))</span> <span class="k">if</span> <span class="n">old_d</span> <span class="o">!=</span> <span class="n">new_d</span><span class="p">]</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Found new top 10 differentials differing in&quot;</span><span class="p">,</span> <span class="n">differing</span><span class="p">)</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="n">newtopdiff</span><span class="p">)</span>
                            <span class="c1"># smart_print(diff2weight)</span>
                    <span class="n">topdiff</span> <span class="o">=</span> <span class="n">newtopdiff</span>

                    <span class="k">if</span> <span class="n">index_ch_found</span> <span class="o">&gt;</span> <span class="n">MAX_CH_FOUND</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">best_ch_found</span><span class="p">,</span> <span class="n">diff2weight</span>

                <span class="k">else</span><span class="p">:</span> <span class="c1"># if not satisfiable</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">last_ch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| No more characteristics found&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| No characteristic found&quot;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">last_ch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Removed assertions&quot;</span><span class="p">)</span>

                        <span class="n">smart_print</span><span class="p">()</span>

                    <span class="n">solver</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

                    <span class="n">target_weight</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">last_ch_found</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">solver</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
                    <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span>
                        <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">target_weight</span><span class="p">),</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="n">solver</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">best_ch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">best_ch_found</span><span class="p">,</span> <span class="n">diff2weight</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| No valid characteristic found&quot;</span><span class="p">)</span>
                <span class="k">return</span>

<div class="viewcode-block" id="SearchCh.formula_size"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.SearchCh.formula_size">[docs]</a>    <span class="k">def</span> <span class="nf">formula_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the size of the underlying SMT problem.</span>

<span class="sd">        See `pysmt.oracles.SizeOracle` for choosing the ``measure``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">reset_env</span><span class="p">()</span>
        <span class="n">bv2pysmt</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">bv2pysmt</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">assertions</span> <span class="o">=</span> <span class="p">[</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">]</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">formula_manager</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="o">*</span><span class="n">assertions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">sizeo</span><span class="o">.</span><span class="n">get_size</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">measure</span><span class="p">)</span></div>

<div class="viewcode-block" id="SearchCh.hrepr"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.SearchCh.hrepr">[docs]</a>    <span class="k">def</span> <span class="nf">hrepr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_repr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a human readable representing of the SMT problem.</span>

<span class="sd">        If ``full_repr`` is False, the short string representation `srepr` is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">representation</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">full_repr</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">srepr</span><span class="p">()</span>
            <span class="n">representation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;assert &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">representation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;minimize </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">representation</span><span class="p">)</span></div>

<div class="viewcode-block" id="SearchCh.error"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.SearchCh.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an upper bound of the weight error of the SMT problem.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">der_mode</span> <span class="o">==</span> <span class="n">DerMode</span><span class="o">.</span><span class="n">ProbabilityOne</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">der_mode</span> <span class="o">==</span> <span class="n">DerMode</span><span class="o">.</span><span class="n">Valid</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">der</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">e</span> <span class="o">+=</span> <span class="n">der</span><span class="o">.</span><span class="n">error</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">e</span></div>

    <span class="k">def</span> <span class="nf">_new_upper_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch_found</span><span class="p">,</span> <span class="n">previous_bound</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the new upper bound given the previous solution.</span>

<span class="sd">        Let me the maximum error of the characteristic (after applying the ceil function).</span>

<span class="sd">        For the previous solution, let:</span>
<span class="sd">         - eiw the integer part of the exact weight</span>
<span class="sd">         - ew the exact weight</span>

<span class="sd">        Assuming there exists a better new solution, let denote by eiw&#39; and ew&#39;</span>
<span class="sd">        the integer part and the full exact weight for this new solution.</span>

<span class="sd">        The worst case (when the new upper bound reduces the least)</span>
<span class="sd">        would be when the better solution has exact weight close</span>
<span class="sd">        to the previous solution, that is, eiw - 1 &lt; ew&#39; &lt; eiw.</span>

<span class="sd">        The weight of this better solution must belong to the following</span>
<span class="sd">        interval with integer endpoints: [eiw - 1, eiw - 1 + me]</span>
<span class="sd">        (assuming the exact weight is smaller than the weight).</span>

<span class="sd">        Therefore the SMT should find characteristics with integer</span>
<span class="sd">        part of the ch_weight up to (but not included) the value eiw + me.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exact_weight</span> <span class="o">=</span> <span class="n">ch_found</span><span class="o">.</span><span class="n">get_exact_weight</span><span class="p">()</span>
        <span class="n">new_bound</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">exact_weight</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">previous_bound</span><span class="p">,</span> <span class="n">new_bound</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_max_weight</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="SearchSkCh"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.SearchSkCh">[docs]</a><span class="k">class</span> <span class="nc">SearchSkCh</span><span class="p">(</span><span class="n">SearchCh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent the problem of finding a `SingleKeyCh` with conditions on the weight.</span>

<span class="sd">    Args:</span>
<span class="sd">        skch (SingleKeyCh): a symbolic single-key characteristic of a `Cipher`</span>
<span class="sd">        der_mode (DerMode): one of the modes available for the derivative weights</span>
<span class="sd">        allow_zero_input_diff(bool): if ``True``, allow the input difference to be zero</span>

<span class="sd">    See also `SearchCh`.</span>

<span class="sd">        &gt;&gt;&gt; from arxpy.differential.difference import XorDiff</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.differential.characteristic import SingleKeyCh</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.smt.search import SearchSkCh</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.primitives import speck</span>
<span class="sd">        &gt;&gt;&gt; Speck32 = speck.get_Speck_instance(speck.SpeckInstance.speck_32_64)</span>
<span class="sd">        &gt;&gt;&gt; Speck32.set_rounds(1)</span>
<span class="sd">        &gt;&gt;&gt; ch = SingleKeyCh(Speck32, XorDiff)</span>
<span class="sd">        &gt;&gt;&gt; search_problem = SearchSkCh(ch)</span>
<span class="sd">        &gt;&gt;&gt; search_problem.formula_size()</span>
<span class="sd">        349</span>
<span class="sd">        &gt;&gt;&gt; search_problem.error()</span>
<span class="sd">        0</span>
<span class="sd">        &gt;&gt;&gt; print(search_problem.hrepr(False))</span>
<span class="sd">        assert ~(0x00000000 == (dp0 :: dp1))</span>
<span class="sd">        assert 0x0000 == ((~(... &lt;&lt; ...) ^ (dx1 &lt;&lt; 0x0001)) &amp; (~(... &lt;&lt; ...) ^ ((... &gt;&gt;&gt; ...) &lt;&lt; 0x0001)) &amp; ((dp1 &lt;&lt; 0x0001) ^ dx1 ^ dp1 ^ (... &gt;&gt;&gt; ...)))</span>
<span class="sd">        assert w0 == PopCount(~((dx1 ^ ~...) &amp; (~... ^ (... &gt;&gt;&gt; ...)))[14:])</span>
<span class="sd">        assert w == w0</span>
<span class="sd">        minimize w</span>
<span class="sd">        &gt;&gt;&gt; search_problem.solve(0).ch_weight</span>
<span class="sd">        0x0</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skch</span><span class="p">,</span> <span class="n">der_mode</span><span class="o">=</span><span class="n">DerMode</span><span class="o">.</span><span class="n">Default</span><span class="p">,</span> <span class="n">allow_zero_input_diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">initial_constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skch</span><span class="p">,</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">SingleKeyCh</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">skch</span><span class="p">,</span> <span class="n">der_mode</span><span class="o">=</span><span class="n">der_mode</span><span class="p">,</span> <span class="n">allow_zero_input_diff</span><span class="o">=</span><span class="n">allow_zero_input_diff</span><span class="p">,</span>
                         <span class="n">initial_constraints</span><span class="o">=</span><span class="n">initial_constraints</span><span class="p">)</span>


<div class="viewcode-block" id="SearchSkCh.solve"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.SearchSkCh.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_weight</span><span class="p">,</span> <span class="n">solver_name</span><span class="o">=</span><span class="s2">&quot;btor&quot;</span><span class="p">,</span> <span class="n">search_mode</span><span class="o">=</span><span class="n">SkChSearchMode</span><span class="o">.</span><span class="n">Optimal</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">return_generator</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Solve the SMT problem associated  to the search of a valid `SingleKeyCh`.</span>

<span class="sd">        See also `SearchCh.solve`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">initial_weight</span> <span class="o">&lt;</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">input_widths</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">search_mode</span><span class="p">,</span> <span class="n">SkChSearchMode</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incremental_solve</span><span class="p">(</span><span class="n">initial_weight</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">,</span> <span class="n">search_mode</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">return_generator</span><span class="p">,</span>
                                       <span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SearchRkCh"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.SearchRkCh">[docs]</a><span class="k">class</span> <span class="nc">SearchRkCh</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent the problem of finding an `RelatedKeyCh` with conditions on the weight.</span>

<span class="sd">    Args:</span>
<span class="sd">        rkch (RelatedKeyCh): a symbolic related-key characteristic of a `Cipher`</span>
<span class="sd">        key_der_mode (DerMode): the derivative mode for the key schedule characteristic</span>
<span class="sd">        enc_der_mode (DerMode): the derivative mode for the encryption characteristic</span>
<span class="sd">        allow_zero_key_input_diff (bool): if ``True``, allow the input difference</span>
<span class="sd">            of the key schedule to be zero</span>
<span class="sd">        allow_zero_enc_input_diff (bool): if ``True``, allow the input difference</span>
<span class="sd">            of the encryption to be zero</span>

<span class="sd">    See also `SearchCh`.</span>

<span class="sd">        &gt;&gt;&gt; from arxpy.differential.difference import XorDiff</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.differential.characteristic import RelatedKeyCh</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.smt.search import SearchRkCh</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.primitives.lea import LeaCipher</span>
<span class="sd">        &gt;&gt;&gt; LeaCipher.set_rounds(1)</span>
<span class="sd">        &gt;&gt;&gt; rkch = RelatedKeyCh(LeaCipher, XorDiff)</span>
<span class="sd">        &gt;&gt;&gt; search_problem = SearchRkCh(rkch)</span>
<span class="sd">        &gt;&gt;&gt; search_problem.formula_size()</span>
<span class="sd">        50495</span>
<span class="sd">        &gt;&gt;&gt; search_problem.key_schedule_problem.error(), search_problem.encryption_problem.error()</span>
<span class="sd">        (4.199250014423123, 0)</span>
<span class="sd">        &gt;&gt;&gt; print(search_problem.hrepr(False))</span>
<span class="sd">        assert ~(0x00000000000000000000000000000000 == (dmk0 :: dmk1 :: dmk2 :: dmk3))</span>
<span class="sd">        assert 0x00000000 == (((... &lt;&lt; ...) &amp; (... &lt;&lt; ...) &amp; ~(... ^ ...) &amp; (~(... &lt;&lt; ...) | (~... ^ ... ^ ...))) | (~(... &lt;&lt; ...) &amp; ~(... &lt;&lt; ...) &amp; (dk0 ^ dmk0)))</span>
<span class="sd">        assert wk0_tmp_0lz == LeadingZeros(~((~... &amp; ~...) &lt;&lt; 0x00000001))</span>
<span class="sd">        assert wk0_tmp_1rev == Reverse((~dk0 &amp; ~dmk0) &lt;&lt; 0x00000001)</span>
<span class="sd">        assert wk0_tmp_2rev == Reverse(~(... &gt;&gt; ...) &amp; ((... &amp; ...) &lt;&lt; 0x00000001) &amp; (~(... ^ ...) &gt;&gt; 0x00000001))</span>
<span class="sd">        assert wk0_tmp_3rev == Reverse(wk0_tmp_2rev ^ wk0_tmp_1rev ^ (wk0_tmp_1rev + wk0_tmp_2rev))</span>
<span class="sd">        assert wk0_tmp_4rev == Reverse((((... &amp; ...) + (... &amp; ...)) &amp; ~(... | ...)) | ((... &amp; ... &amp; (... &gt;&gt; ...)) - ((... + ...) &amp; (... | ...))))</span>
<span class="sd">        assert wk0 == (((PopCountDiff((... &amp; ...) | (... &lt;&lt; ...), (... &amp; ...) ^ ... ^ ...)) :: 0b000) - (0b00 :: ((0b0 :: PopCount(...)) + (PopCount(...) :: 0b0))))</span>
<span class="sd">        assert 0x00000000 == (((... &lt;&lt; ...) &amp; (... &lt;&lt; ...) &amp; ~(... ^ ...) &amp; (~(... &lt;&lt; ...) | (~... ^ ... ^ ...))) | (~(... &lt;&lt; ...) &amp; ~(... &lt;&lt; ...) &amp; (dk2 ^ dmk1)))</span>
<span class="sd">        assert wk1_tmp_0lz == LeadingZeros(~((~... &amp; ~...) &lt;&lt; 0x00000001))</span>
<span class="sd">        assert wk1_tmp_1rev == Reverse((~dk2 &amp; ~dmk1) &lt;&lt; 0x00000001)</span>
<span class="sd">        assert wk1_tmp_2rev == Reverse(~(... &gt;&gt; ...) &amp; ((... &amp; ...) &lt;&lt; 0x00000001) &amp; (~(... ^ ...) &gt;&gt; 0x00000001))</span>
<span class="sd">        assert wk1_tmp_3rev == Reverse(wk1_tmp_2rev ^ wk1_tmp_1rev ^ (wk1_tmp_1rev + wk1_tmp_2rev))</span>
<span class="sd">        assert wk1_tmp_4rev == Reverse((((... &amp; ...) + (... &amp; ...)) &amp; ~(... | ...)) | ((... &amp; ... &amp; (... &gt;&gt; ...)) - ((... + ...) &amp; (... | ...))))</span>
<span class="sd">        assert wk1 == (((PopCountDiff((... &amp; ...) | (... &lt;&lt; ...), (... &amp; ...) ^ ... ^ ...)) :: 0b000) - (0b00 :: ((0b0 :: PopCount(...)) + (PopCount(...) :: 0b0))))</span>
<span class="sd">        assert 0x00000000 == (((... &lt;&lt; ...) &amp; (... &lt;&lt; ...) &amp; ~(... ^ ...) &amp; (~(... &lt;&lt; ...) | (~... ^ ... ^ ...))) | (~(... &lt;&lt; ...) &amp; ~(... &lt;&lt; ...) &amp; (dk4 ^ dmk2)))</span>
<span class="sd">        assert wk2_tmp_0lz == LeadingZeros(~((~... &amp; ~...) &lt;&lt; 0x00000001))</span>
<span class="sd">        assert wk2_tmp_1rev == Reverse((~dk4 &amp; ~dmk2) &lt;&lt; 0x00000001)</span>
<span class="sd">        assert wk2_tmp_2rev == Reverse(~(... &gt;&gt; ...) &amp; ((... &amp; ...) &lt;&lt; 0x00000001) &amp; (~(... ^ ...) &gt;&gt; 0x00000001))</span>
<span class="sd">        assert wk2_tmp_3rev == Reverse(wk2_tmp_2rev ^ wk2_tmp_1rev ^ (wk2_tmp_1rev + wk2_tmp_2rev))</span>
<span class="sd">        assert wk2_tmp_4rev == Reverse((((... &amp; ...) + (... &amp; ...)) &amp; ~(... | ...)) | ((... &amp; ... &amp; (... &gt;&gt; ...)) - ((... + ...) &amp; (... | ...))))</span>
<span class="sd">        assert wk2 == (((PopCountDiff((... &amp; ...) | (... &lt;&lt; ...), (... &amp; ...) ^ ... ^ ...)) :: 0b000) - (0b00 :: ((0b0 :: PopCount(...)) + (PopCount(...) :: 0b0))))</span>
<span class="sd">        assert (0b0000000000000000000000000000000 == ((... &amp; ... &amp; ~... &amp; (~... | (... ^ ...))) | (~... &amp; ~... &amp; ((dk6[:1]) ^ (dmk3[:1]))))) &amp; ((dk6[0]) == (dmk3[0]))</span>
<span class="sd">        assert wk3_tmp_0lz == LeadingZeros(~((~... &amp; ~...) &lt;&lt; 0b0000000000000000000000000000001))</span>
<span class="sd">        assert wk3_tmp_1rev == Reverse((~(dk6[:1]) &amp; ~(dmk3[:1])) &lt;&lt; 0b0000000000000000000000000000001)</span>
<span class="sd">        assert wk3_tmp_2rev == Reverse(~(... &gt;&gt; ...) &amp; ((... &amp; ...) &lt;&lt; 0b0000000000000000000000000000001) &amp; (~(... ^ ...) &gt;&gt; 0b0000000000000000000000000000001))</span>
<span class="sd">        assert wk3_tmp_3rev == Reverse(wk3_tmp_2rev ^ wk3_tmp_1rev ^ (wk3_tmp_1rev + wk3_tmp_2rev))</span>
<span class="sd">        assert wk3_tmp_4rev == Reverse((((... &amp; ...) + (... &amp; ...)) &amp; ~(... | ...)) | ((... &amp; ... &amp; (... &gt;&gt; ...)) - ((... + ...) &amp; (... | ...))))</span>
<span class="sd">        assert wk3 == (((PopCountDiff((... &amp; ...) | (... &lt;&lt; ...), (... &amp; ...) ^ ... ^ ...)) :: 0b000) - (0b00 :: ((0b0 :: PopCount(...)) + (PopCount(...) :: 0b0))))</span>
<span class="sd">        assert wk == (((0b0 :: wk0) + (0b0 :: wk1) + (0b0 :: wk2) + (0b00 :: wk3))[:3])</span>
<span class="sd">        minimize wk</span>
<span class="sd">        assert 0x00000000 == ((~(... &lt;&lt; ...) ^ (dx2 &lt;&lt; 0x00000001)) &amp; (~(... &lt;&lt; ...) ^ ((... ^ ...) &lt;&lt; 0x00000001)) &amp; (((dp0 ^ (... &lt;&lt;&lt; ...)) &lt;&lt; 0x00000001) ^ dx2 ^ dp0 ^ (... &lt;&lt;&lt; ...) ^ dp1 ^ (... &lt;&lt;&lt; ...)))</span>
<span class="sd">        assert 0x00000000 == ((~(... &lt;&lt; ...) ^ (dx6 &lt;&lt; 0x00000001)) &amp; (~(... &lt;&lt; ...) ^ ((... ^ ...) &lt;&lt; 0x00000001)) &amp; (((dp1 ^ (... &lt;&lt;&lt; ...)) &lt;&lt; 0x00000001) ^ dx6 ^ dp1 ^ (... &lt;&lt;&lt; ...) ^ dp2 ^ (... &lt;&lt;&lt; ...)))</span>
<span class="sd">        assert 0x00000000 == ((~(... &lt;&lt; ...) ^ (dx10 &lt;&lt; 0x00000001)) &amp; (~(... &lt;&lt; ...) ^ ((... ^ ...) &lt;&lt; 0x00000001)) &amp; (((dp2 ^ (... &lt;&lt;&lt; ...)) &lt;&lt; 0x00000001) ^ dx10 ^ dp2 ^ (... &lt;&lt;&lt; ...) ^ dp3 ^ (... &lt;&lt;&lt; ...)))</span>
<span class="sd">        assert w0w1w2 == (PopCountSum3(~((dx10 ^ ~...) &amp; (~... ^ ... ^ ...))[30:], ~((dx2 ^ ~...) &amp; (~... ^ ... ^ ...))[30:], ~((dx6 ^ ~...) &amp; (~... ^ ... ^ ...))[30:]))</span>
<span class="sd">        assert w == w0w1w2</span>
<span class="sd">        minimize w</span>
<span class="sd">        &gt;&gt;&gt; rkch_found = search_problem.solve(0, 0, solver_name=&quot;btor&quot;)</span>
<span class="sd">        &gt;&gt;&gt; rkch_found.key_ch_found.ch_weight, rkch_found.enc_ch_found.ch_weight</span>
<span class="sd">        (0b0000000, 0b0000000)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rkch</span><span class="p">,</span> <span class="n">key_der_mode</span><span class="o">=</span><span class="n">DerMode</span><span class="o">.</span><span class="n">Default</span><span class="p">,</span> <span class="n">enc_der_mode</span><span class="o">=</span><span class="n">DerMode</span><span class="o">.</span><span class="n">Default</span><span class="p">,</span>
                 <span class="n">allow_zero_key_input_diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_zero_enc_input_diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">initial_key_constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_enc_constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rkch</span><span class="p">,</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">RelatedKeyCh</span><span class="p">)</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">reset_env</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">env</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">key_schedule_problem</span> <span class="o">=</span> <span class="n">SearchCh</span><span class="p">(</span>
            <span class="n">ch</span><span class="o">=</span><span class="n">rkch</span><span class="o">.</span><span class="n">key_schedule_ch</span><span class="p">,</span> <span class="n">allow_zero_input_diff</span><span class="o">=</span><span class="n">allow_zero_key_input_diff</span><span class="p">,</span>
            <span class="n">der_mode</span><span class="o">=</span><span class="n">key_der_mode</span><span class="p">,</span> <span class="n">weight_prefix</span><span class="o">=</span><span class="s2">&quot;wk&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">initial_constraints</span><span class="o">=</span><span class="n">initial_key_constraints</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encryption_problem</span> <span class="o">=</span> <span class="n">SearchCh</span><span class="p">(</span>
            <span class="n">ch</span><span class="o">=</span><span class="n">rkch</span><span class="o">.</span><span class="n">encryption_ch</span><span class="p">,</span> <span class="n">allow_zero_input_diff</span><span class="o">=</span><span class="n">allow_zero_enc_input_diff</span><span class="p">,</span>
            <span class="n">der_mode</span><span class="o">=</span><span class="n">enc_der_mode</span><span class="p">,</span> <span class="n">weight_prefix</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">initial_constraints</span><span class="o">=</span><span class="n">initial_enc_constraints</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rkch</span> <span class="o">=</span> <span class="n">rkch</span>

<div class="viewcode-block" id="SearchRkCh.formula_size"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.SearchRkCh.formula_size">[docs]</a>    <span class="k">def</span> <span class="nf">formula_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the size of the underlying SMT problem.</span>

<span class="sd">        See  also `SearchCh.formula_size`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_schedule_problem</span><span class="o">.</span><span class="n">formula_size</span><span class="p">(</span><span class="n">measure</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">encryption_problem</span><span class="o">.</span><span class="n">formula_size</span><span class="p">(</span><span class="n">measure</span><span class="p">)</span></div>

<div class="viewcode-block" id="SearchRkCh.hrepr"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.SearchRkCh.hrepr">[docs]</a>    <span class="k">def</span> <span class="nf">hrepr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_repr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a human readable representing of the SMT problem.</span>

<span class="sd">        See  also `SearchCh.hrepr`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key_hrepr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_schedule_problem</span><span class="o">.</span><span class="n">hrepr</span><span class="p">(</span><span class="n">full_repr</span><span class="p">)</span>
        <span class="n">enc_hrepr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encryption_problem</span><span class="o">.</span><span class="n">hrepr</span><span class="p">(</span><span class="n">full_repr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key_hrepr</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">enc_hrepr</span></div>

<div class="viewcode-block" id="SearchRkCh.solve"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.SearchRkCh.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_ew</span><span class="p">,</span> <span class="n">initial_kw</span><span class="p">,</span> <span class="n">solver_name</span><span class="o">=</span><span class="s2">&quot;btor&quot;</span><span class="p">,</span> <span class="n">search_mode</span><span class="o">=</span><span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalMinSum</span><span class="p">,</span>
              <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Solve the SMT problem associated to the search a valid `RelatedKeyCh`.</span>

<span class="sd">        Args:</span>
<span class="sd">             initial_ew(int): the initial encryption weight for starting the iterative search</span>
<span class="sd">             initial_kw(int): the initial key schedule weight for starting the iterative search</span>
<span class="sd">             solver_name(str): the name of the solver (according to pySMT) to be used</span>
<span class="sd">             search_mode(RkChSearchMode): one of the search modes available</span>
<span class="sd">             check(bool): if ``True``, `RkChFound.check_empirical_weight` will be called</span>
<span class="sd">                after a characteristic is found. If it is not valid, the search will continue.</span>
<span class="sd">             verbose_level(int): an integer between ``0`` (no verbose) and ``3`` (full verbose).</span>
<span class="sd">             filename(str): if not ``None``, the output will be  printed to the given file</span>
<span class="sd">                rather than the to stdout.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_schedule_problem</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encryption_problem</span>
        <span class="k">assert</span> <span class="n">initial_ew</span> <span class="o">&lt;</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">input_widths</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">error</span><span class="p">())</span>
        <span class="k">assert</span> <span class="n">initial_kw</span> <span class="o">&lt;</span> <span class="nb">sum</span><span class="p">(</span><span class="n">kp</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">input_widths</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">kp</span><span class="o">.</span><span class="n">error</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">search_mode</span><span class="p">,</span> <span class="n">RkChSearchMode</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incremental_solve</span><span class="p">(</span><span class="n">initial_ew</span><span class="p">,</span> <span class="n">initial_kw</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">,</span> <span class="n">search_mode</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span>
                                       <span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>

    <span class="c1"># noinspection PyPep8</span>
    <span class="k">def</span> <span class="nf">_incremental_solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_ew</span><span class="p">,</span> <span class="n">initial_kw</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">,</span> <span class="n">search_mode</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span>
                           <span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">strict_shift</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">solver_name</span> <span class="o">==</span> <span class="s2">&quot;btor&quot;</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">bv2pysmt</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">bv2pysmt</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">,</span> <span class="n">strict_shift</span><span class="o">=</span><span class="n">strict_shift</span><span class="p">)</span>
        <span class="n">smart_print</span> <span class="o">=</span> <span class="n">_get_smart_print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">kp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_schedule_problem</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encryption_problem</span>

        <span class="k">def</span> <span class="nf">sum_weights</span><span class="p">(</span><span class="n">key_weight</span><span class="p">,</span> <span class="n">enc_weight</span><span class="p">):</span>
            <span class="n">ch_max_weight</span> <span class="o">=</span> <span class="n">kp</span><span class="o">.</span><span class="n">ch_max_weight</span> <span class="o">+</span> <span class="n">ep</span><span class="o">.</span><span class="n">ch_max_weight</span>
            <span class="n">ch_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ch_max_weight</span><span class="o">.</span><span class="n">bit_length</span><span class="p">(),</span> <span class="n">key_weight</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">enc_weight</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">operation</span><span class="o">.</span><span class="n">ZeroExtend</span><span class="p">(</span><span class="n">key_weight</span><span class="p">,</span> <span class="n">ch_width</span> <span class="o">-</span> <span class="n">key_weight</span><span class="o">.</span><span class="n">width</span><span class="p">)</span> <span class="o">+</span> \
                   <span class="n">operation</span><span class="o">.</span><span class="n">ZeroExtend</span><span class="p">(</span><span class="n">enc_weight</span><span class="p">,</span> <span class="n">ch_width</span> <span class="o">-</span> <span class="n">enc_weight</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>

        <span class="n">differences_in_model</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">kp</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">input_diff</span><span class="p">,</span> <span class="n">kp</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                 <span class="n">ep</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">input_diff</span><span class="p">,</span> <span class="n">ep</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nonlinear_diffs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">differences_in_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">Solver</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">solver_name</span><span class="p">,</span> <span class="n">logic</span><span class="o">=</span><span class="n">logics</span><span class="o">.</span><span class="n">QF_BV</span><span class="p">)</span> <span class="k">as</span> <span class="n">solver</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">kp</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
                <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ep</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
                <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="n">key_max_error</span> <span class="o">=</span> <span class="n">kp</span><span class="o">.</span><span class="n">error</span><span class="p">()</span>
            <span class="n">key_orig_upper_bound</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">kp</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">input_widths</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">key_max_error</span><span class="p">)</span>
            <span class="n">key_upper_bound</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">key_orig_upper_bound</span><span class="p">,</span> <span class="n">kp</span><span class="o">.</span><span class="n">ch_max_weight</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">enc_max_error</span> <span class="o">=</span> <span class="n">ep</span><span class="o">.</span><span class="n">error</span><span class="p">()</span>
            <span class="n">enc_orig_upper_bound</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">input_widths</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">enc_max_error</span><span class="p">)</span>
            <span class="n">enc_upper_bound</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">enc_orig_upper_bound</span><span class="p">,</span> <span class="n">ep</span><span class="o">.</span><span class="n">ch_max_weight</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Key schedule ch. upper bound: </span><span class="si">{}</span><span class="s2">, max error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">key_upper_bound</span><span class="p">,</span> <span class="n">key_max_error</span>
                <span class="p">))</span>
                <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Encryption ch. upper bound: </span><span class="si">{}</span><span class="s2">, max error: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">enc_upper_bound</span><span class="p">,</span> <span class="n">enc_max_error</span>
                <span class="p">))</span>

            <span class="k">if</span> <span class="n">search_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstMinSum</span><span class="p">,</span>
                               <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstValidKeyMinEnc</span><span class="p">,</span>
                               <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstFixEncMinKey</span><span class="p">]:</span>

                <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstMinSum</span><span class="p">:</span>
                    <span class="n">target_weight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">initial_ew</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">initial_kw</span><span class="p">)</span>
                    <span class="n">upper_bound</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="n">enc_upper_bound</span> <span class="o">+</span> <span class="n">key_upper_bound</span><span class="p">,</span>
                        <span class="n">kp</span><span class="o">.</span><span class="n">ch_max_weight</span> <span class="o">+</span> <span class="n">ep</span><span class="o">.</span><span class="n">ch_max_weight</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># to not count +1 twice</span>
                    <span class="p">)</span>
                    <span class="n">get_assertion</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tw</span><span class="p">:</span> <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">sum_weights</span><span class="p">(</span><span class="n">kp</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">ep</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">),</span> <span class="n">tw</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstValidKeyMinEnc</span><span class="p">:</span>
                    <span class="n">target_weight</span> <span class="o">=</span> <span class="n">initial_ew</span>
                    <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">enc_upper_bound</span>
                    <span class="k">if</span> <span class="n">key_orig_upper_bound</span> <span class="o">&lt;=</span> <span class="n">kp</span><span class="o">.</span><span class="n">ch_max_weight</span><span class="p">:</span>
                        <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">kp</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">&lt;</span> <span class="n">key_orig_upper_bound</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Added assertion:&quot;</span><span class="p">,</span> <span class="n">kp</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">&lt;</span> <span class="n">key_orig_upper_bound</span><span class="p">)</span>
                    <span class="n">get_assertion</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tw</span><span class="p">:</span> <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">tw</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstFixEncMinKey</span><span class="p">:</span>
                    <span class="n">target_weight</span> <span class="o">=</span> <span class="n">initial_kw</span>
                    <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">key_upper_bound</span>
                    <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span>
                        <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">initial_ew</span><span class="p">),</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Added assertion:&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">initial_ew</span><span class="p">))</span>
                    <span class="n">get_assertion</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tw</span><span class="p">:</span> <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">kp</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">tw</span><span class="p">)</span>

                <span class="k">while</span> <span class="n">target_weight</span> <span class="o">&lt;</span> <span class="n">upper_bound</span><span class="p">:</span>
                    <span class="n">assertion</span> <span class="o">=</span> <span class="n">get_assertion</span><span class="p">(</span><span class="n">target_weight</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Solving&quot;</span><span class="p">,</span> <span class="n">assertion</span><span class="p">)</span>
                    <span class="n">satisfiable</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">([</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">assertion</span><span class="p">,</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span>

                    <span class="k">if</span> <span class="n">satisfiable</span><span class="p">:</span>
                        <span class="n">model</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">pysmt_model2bv_model</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">get_model</span><span class="p">(),</span> <span class="n">differences_in_model</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstMinSum</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="n">sum_weights</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">kp</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">],</span> <span class="n">model</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">])</span> <span class="o">==</span> <span class="n">target_weight</span>
                        <span class="k">elif</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstValidKeyMinEnc</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="n">model</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_weight</span>
                        <span class="k">elif</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstFixEncMinKey</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="n">model</span><span class="p">[</span><span class="n">kp</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_weight</span>

                        <span class="n">rkch_found</span> <span class="o">=</span> <span class="n">RkChFound</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rkch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_schedule_problem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encryption_problem</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">rkch_found</span><span class="o">.</span><span class="n">check_empirical_weight</span><span class="p">(</span><span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                            <span class="k">except</span> <span class="n">ExactWeightError</span><span class="p">:</span>
                                <span class="n">rkch_found</span><span class="o">.</span><span class="n">key_ch_found</span><span class="o">.</span><span class="n">emp_weight</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>
                                <span class="n">rkch_found</span><span class="o">.</span><span class="n">enc_ch_found</span><span class="o">.</span><span class="n">emp_weight</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>

                        <span class="k">return</span> <span class="n">rkch_found</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">target_weight</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Unsatisfiable&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">AllValid</span><span class="p">:</span>
                <span class="n">last_rkch_found</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">rkch_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rkch</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">characteristic</span><span class="o">.</span><span class="n">ChSignatureType</span><span class="o">.</span><span class="n">Full</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">key_orig_upper_bound</span> <span class="o">&lt;=</span> <span class="n">kp</span><span class="o">.</span><span class="n">ch_max_weight</span><span class="p">:</span>
                    <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">kp</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">&lt;</span> <span class="n">key_orig_upper_bound</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Added assertion:&quot;</span><span class="p">,</span> <span class="n">kp</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">&lt;</span> <span class="n">key_orig_upper_bound</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">enc_orig_upper_bound</span> <span class="o">&lt;=</span> <span class="n">ep</span><span class="o">.</span><span class="n">ch_max_weight</span><span class="p">:</span>
                    <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">&lt;</span> <span class="n">enc_orig_upper_bound</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Added assertion:&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">&lt;</span> <span class="n">enc_orig_upper_bound</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">MAX_CH_FOUND</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">last_rkch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">candidate_sig</span> <span class="o">=</span> <span class="n">last_rkch_found</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">characteristic</span><span class="o">.</span><span class="n">ChSignatureType</span><span class="o">.</span><span class="n">Full</span><span class="p">)</span>
                        <span class="c1"># disable simplification due to recursion error</span>
                        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">Simplification</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
                            <span class="n">c</span> <span class="o">=</span> <span class="o">~</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">rkch_sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">candidate_sig</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rkch_sig</span><span class="p">)):</span>
                                <span class="n">c</span> <span class="o">|=</span> <span class="o">~</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">rkch_sig</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">candidate_sig</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Added assertion:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Solving&quot;</span><span class="p">)</span>
                    <span class="n">satisfiable</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">satisfiable</span><span class="p">:</span>
                        <span class="n">model</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">pysmt_model2bv_model</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">get_model</span><span class="p">(),</span> <span class="n">differences_in_model</span><span class="p">)</span>
                        <span class="n">last_rkch_found</span> <span class="o">=</span> <span class="n">RkChFound</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rkch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_schedule_problem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encryption_problem</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

                        <span class="n">valid_ch</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">last_rkch_found</span><span class="o">.</span><span class="n">check_empirical_weight</span><span class="p">(</span><span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                            <span class="k">except</span> <span class="n">ExactWeightError</span><span class="p">:</span>
                                <span class="n">valid_ch</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Found invalid characteristic&quot;</span><span class="p">)</span>
                                    <span class="n">smart_print</span><span class="p">(</span><span class="n">last_rkch_found</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                                        <span class="n">smart_print</span><span class="p">(</span><span class="n">last_rkch_found</span><span class="o">.</span><span class="n">vrepr</span><span class="p">())</span>

                        <span class="k">if</span> <span class="n">valid_ch</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Found characteristic&quot;</span><span class="p">)</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="n">last_rkch_found</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="n">last_rkch_found</span><span class="o">.</span><span class="n">vrepr</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">last_rkch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| No more characteristics found&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| No characteristic found&quot;</span><span class="p">)</span>
                        <span class="n">smart_print</span><span class="p">()</span>
                        <span class="k">return</span>

            <span class="k">if</span> <span class="n">search_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalMinSum</span><span class="p">,</span>
                               <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalMinSumDifferential</span><span class="p">,</span>
                               <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalValidKeyMinEnc</span><span class="p">,</span>
                               <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalValidKeyMinEncDifferential</span><span class="p">,</span>
                               <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalFixEncMinKey</span><span class="p">,</span>
                               <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalFixEncMinKeyDifferential</span><span class="p">,</span>
                               <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstMinSumValid</span><span class="p">,</span>
                               <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstFixEncMinKeyValid</span><span class="p">,</span>
                               <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstValidKeyMinEncValid</span><span class="p">,</span>
                               <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">AllOptimalMinSum</span><span class="p">]:</span>
                <span class="n">min_exact_weight</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>
                <span class="n">best_rkch_found</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">last_rkch_found</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">signature_type</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">search_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalMinSum</span><span class="p">,</span>
                                   <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalMinSumDifferential</span><span class="p">,</span>
                                   <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstMinSumValid</span><span class="p">,</span>
                                   <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">AllOptimalMinSum</span><span class="p">]:</span>
                    <span class="n">target_weight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">initial_ew</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">initial_kw</span><span class="p">)</span>
                    <span class="n">upper_bound</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="n">enc_upper_bound</span> <span class="o">+</span> <span class="n">key_upper_bound</span><span class="p">,</span>
                        <span class="n">kp</span><span class="o">.</span><span class="n">ch_max_weight</span> <span class="o">+</span> <span class="n">ep</span><span class="o">.</span><span class="n">ch_max_weight</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># + 1, not + 2</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">search_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalMinSum</span><span class="p">,</span> <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">AllOptimalMinSum</span><span class="p">]:</span>
                        <span class="n">signature_type</span> <span class="o">=</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">ChSignatureType</span><span class="o">.</span><span class="n">Full</span>
                    <span class="k">elif</span> <span class="n">search_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalMinSumDifferential</span><span class="p">,</span> <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstMinSumValid</span><span class="p">]:</span>
                        <span class="n">signature_type</span> <span class="o">=</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">ChSignatureType</span><span class="o">.</span><span class="n">InputOutput</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid search_mode&quot;</span><span class="p">)</span>
                    <span class="n">rkch_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rkch</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">signature_type</span><span class="p">)</span>

                    <span class="n">get_assertion</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tw</span><span class="p">:</span> <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">sum_weights</span><span class="p">(</span><span class="n">kp</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">ep</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">),</span> <span class="n">tw</span><span class="p">)</span>
                    <span class="n">get_sig</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rkf</span><span class="p">:</span> <span class="n">rkf</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">signature_type</span><span class="p">)</span>
                    <span class="n">get_sig_str</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rkf</span><span class="p">:</span> <span class="n">rkf</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">signature_type</span><span class="p">,</span> <span class="n">return_str</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">get_exact_weight</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rkf</span><span class="p">:</span> <span class="n">rkf</span><span class="o">.</span><span class="n">key_ch_found</span><span class="o">.</span><span class="n">get_exact_weight</span><span class="p">()</span> <span class="o">+</span> <span class="n">rkf</span><span class="o">.</span><span class="n">enc_ch_found</span><span class="o">.</span><span class="n">get_exact_weight</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">AllOptimalMinSum</span><span class="p">:</span>
                        <span class="n">get_upper_bound</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rkf</span><span class="p">,</span> <span class="n">pub</span><span class="p">:</span> <span class="n">pub</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">get_upper_bound</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rkf</span><span class="p">,</span> <span class="n">pub</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span>
                            <span class="n">kp</span><span class="o">.</span><span class="n">_new_upper_bound</span><span class="p">(</span><span class="n">rkf</span><span class="o">.</span><span class="n">key_ch_found</span><span class="p">,</span> <span class="n">key_upper_bound</span><span class="p">)</span> <span class="o">+</span>
                            <span class="n">ep</span><span class="o">.</span><span class="n">_new_upper_bound</span><span class="p">(</span><span class="n">rkf</span><span class="o">.</span><span class="n">enc_ch_found</span><span class="p">,</span> <span class="n">enc_upper_bound</span><span class="p">),</span>
                            <span class="n">pub</span>
                        <span class="p">)</span>

                <span class="k">elif</span> <span class="n">search_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalValidKeyMinEnc</span><span class="p">,</span>
                                     <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalValidKeyMinEncDifferential</span><span class="p">,</span>
                                     <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstValidKeyMinEncValid</span><span class="p">]:</span>
                    <span class="n">target_weight</span> <span class="o">=</span> <span class="n">initial_ew</span>
                    <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">enc_upper_bound</span>
                    <span class="k">if</span> <span class="n">key_orig_upper_bound</span> <span class="o">&lt;=</span> <span class="n">kp</span><span class="o">.</span><span class="n">ch_max_weight</span><span class="p">:</span>
                        <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">kp</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">&lt;</span> <span class="n">key_orig_upper_bound</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Added assertion:&quot;</span><span class="p">,</span> <span class="n">kp</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">&lt;</span> <span class="n">key_orig_upper_bound</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalValidKeyMinEnc</span><span class="p">:</span>
                        <span class="n">signature_type</span> <span class="o">=</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">ChSignatureType</span><span class="o">.</span><span class="n">Full</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">signature_type</span> <span class="o">=</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">ChSignatureType</span><span class="o">.</span><span class="n">InputOutput</span>
                    <span class="n">rkch_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rkch</span><span class="o">.</span><span class="n">encryption_ch</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">signature_type</span><span class="p">)</span>

                    <span class="n">get_assertion</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tw</span><span class="p">:</span> <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">tw</span><span class="p">)</span>
                    <span class="n">get_sig</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rkf</span><span class="p">:</span> <span class="n">rkf</span><span class="o">.</span><span class="n">enc_ch_found</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">signature_type</span><span class="p">)</span>
                    <span class="n">get_sig_str</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rkf</span><span class="p">:</span> <span class="n">rkf</span><span class="o">.</span><span class="n">enc_ch_found</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">signature_type</span><span class="p">,</span> <span class="n">return_str</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">get_exact_weight</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rkf</span><span class="p">:</span> <span class="n">rkf</span><span class="o">.</span><span class="n">enc_ch_found</span><span class="o">.</span><span class="n">get_exact_weight</span><span class="p">()</span>
                    <span class="n">get_upper_bound</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rkf</span><span class="p">,</span> <span class="n">pub</span><span class="p">:</span> <span class="n">ep</span><span class="o">.</span><span class="n">_new_upper_bound</span><span class="p">(</span><span class="n">rkf</span><span class="o">.</span><span class="n">enc_ch_found</span><span class="p">,</span> <span class="n">pub</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">search_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalFixEncMinKey</span><span class="p">,</span>
                                     <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalFixEncMinKeyDifferential</span><span class="p">,</span>
                                     <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstFixEncMinKeyValid</span><span class="p">]:</span>
                    <span class="n">target_weight</span> <span class="o">=</span> <span class="n">initial_kw</span>
                    <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">key_upper_bound</span>
                    <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span>
                        <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">initial_ew</span><span class="p">),</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Added assertion:&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">initial_ew</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">OptimalFixEncMinKey</span><span class="p">:</span>
                        <span class="n">signature_type</span> <span class="o">=</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">ChSignatureType</span><span class="o">.</span><span class="n">Full</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">signature_type</span> <span class="o">=</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">ChSignatureType</span><span class="o">.</span><span class="n">InputOutput</span>
                    <span class="n">rkch_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rkch</span><span class="o">.</span><span class="n">key_schedule_ch</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">signature_type</span><span class="p">)</span>

                    <span class="n">get_assertion</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tw</span><span class="p">:</span> <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">kp</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="n">tw</span><span class="p">)</span>
                    <span class="n">get_sig</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rkf</span><span class="p">:</span> <span class="n">rkf</span><span class="o">.</span><span class="n">key_ch_found</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">signature_type</span><span class="p">)</span>
                    <span class="n">get_sig_str</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rkf</span><span class="p">:</span> <span class="n">rkf</span><span class="o">.</span><span class="n">key_ch_found</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">signature_type</span><span class="p">,</span> <span class="n">return_str</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">get_exact_weight</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rkf</span><span class="p">:</span> <span class="n">rkf</span><span class="o">.</span><span class="n">key_ch_found</span><span class="o">.</span><span class="n">get_exact_weight</span><span class="p">()</span>
                    <span class="n">get_upper_bound</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rkf</span><span class="p">,</span> <span class="n">pub</span><span class="p">:</span> <span class="n">kp</span><span class="o">.</span><span class="n">_new_upper_bound</span><span class="p">(</span><span class="n">rkf</span><span class="o">.</span><span class="n">key_ch_found</span><span class="p">,</span> <span class="n">pub</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid search mode: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">search_mode</span><span class="p">))</span>

                <span class="n">solver</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
                <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">get_assertion</span><span class="p">(</span><span class="n">target_weight</span><span class="p">),</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

                <span class="k">while</span> <span class="n">target_weight</span> <span class="o">&lt;</span> <span class="n">upper_bound</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">last_rkch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">candidate_sig</span> <span class="o">=</span> <span class="n">get_sig</span><span class="p">(</span><span class="n">last_rkch_found</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_sig</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="o">~</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">rkch_sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">candidate_sig</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rkch_sig</span><span class="p">)):</span>
                            <span class="n">c</span> <span class="o">|=</span> <span class="o">~</span><span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">rkch_sig</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">candidate_sig</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Added assertion:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Solving&quot;</span><span class="p">,</span> <span class="n">get_assertion</span><span class="p">(</span><span class="n">target_weight</span><span class="p">))</span>
                    <span class="n">satisfiable</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">satisfiable</span><span class="p">:</span>
                        <span class="n">model</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">pysmt_model2bv_model</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">get_model</span><span class="p">(),</span> <span class="n">differences_in_model</span><span class="p">)</span>

                        <span class="n">last_rkch_found</span> <span class="o">=</span> <span class="n">RkChFound</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rkch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_schedule_problem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encryption_problem</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

                        <span class="n">exact_weight</span> <span class="o">=</span> <span class="n">get_exact_weight</span><span class="p">(</span><span class="n">last_rkch_found</span><span class="p">)</span>

                        <span class="n">valid_ch</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="n">exact_weight</span> <span class="o">&lt;</span> <span class="n">min_exact_weight</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">last_rkch_found</span><span class="o">.</span><span class="n">check_empirical_weight</span><span class="p">(</span><span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                                <span class="k">except</span> <span class="n">ExactWeightError</span><span class="p">:</span>
                                    <span class="n">valid_ch</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Found invalid characteristic&quot;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                                            <span class="n">smart_print</span><span class="p">(</span><span class="n">last_rkch_found</span><span class="o">.</span><span class="n">vrepr</span><span class="p">())</span>

                            <span class="k">if</span> <span class="n">valid_ch</span><span class="p">:</span>
                                <span class="n">best_rkch_found</span> <span class="o">=</span> <span class="n">last_rkch_found</span>
                                <span class="n">min_exact_weight</span> <span class="o">=</span> <span class="n">exact_weight</span>
                                <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Found better characteristic&quot;</span><span class="p">)</span>
                                    <span class="n">smart_print</span><span class="p">(</span><span class="n">last_rkch_found</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                                        <span class="n">smart_print</span><span class="p">(</span><span class="n">last_rkch_found</span><span class="o">.</span><span class="n">vrepr</span><span class="p">())</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| Found worse characteristic (not checked)&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                                    <span class="n">smart_print</span><span class="p">(</span><span class="n">last_rkch_found</span><span class="o">.</span><span class="n">vrepr</span><span class="p">())</span>

                        <span class="k">if</span> <span class="n">valid_ch</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">search_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstMinSumValid</span><span class="p">,</span>
                                               <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstValidKeyMinEncValid</span><span class="p">,</span>
                                               <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">FirstFixEncMinKeyValid</span><span class="p">]:</span>
                                <span class="k">return</span> <span class="n">last_rkch_found</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">new_upper_bound</span> <span class="o">=</span> <span class="n">get_upper_bound</span><span class="p">(</span><span class="n">last_rkch_found</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">exact_weight</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">target_weight</span> <span class="o">&gt;=</span> <span class="n">upper_bound</span><span class="p">:</span>
                                    <span class="k">break</span>
                                <span class="k">if</span> <span class="n">new_upper_bound</span> <span class="o">!=</span> <span class="n">upper_bound</span> <span class="ow">and</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;New upper bound:&quot;</span><span class="p">,</span> <span class="n">new_upper_bound</span><span class="p">)</span>
                                <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">new_upper_bound</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">last_rkch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| No more characteristics found&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| No characteristic found&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">last_rkch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Removed assertions&quot;</span><span class="p">)</span>
                            <span class="n">smart_print</span><span class="p">()</span>

                        <span class="n">solver</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

                        <span class="n">target_weight</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">last_rkch_found</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">solver</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
                        <span class="n">solver</span><span class="o">.</span><span class="n">add_assertion</span><span class="p">(</span><span class="n">bv2pysmt</span><span class="p">(</span><span class="n">get_assertion</span><span class="p">(</span><span class="n">target_weight</span><span class="p">),</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">best_rkch_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">best_rkch_found</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">smart_print</span><span class="p">(</span><span class="n">_get_time</span><span class="p">(),</span> <span class="s2">&quot;| No valid characteristic found&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="round_based_search_SkCh"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.round_based_search_SkCh">[docs]</a><span class="k">def</span> <span class="nf">round_based_search_SkCh</span><span class="p">(</span><span class="n">cipher</span><span class="p">,</span> <span class="n">diff_type</span><span class="p">,</span> <span class="n">initial_weight</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">,</span> <span class="n">start_round</span><span class="p">,</span> <span class="n">end_round</span><span class="p">,</span>
                            <span class="n">der_mode</span><span class="p">,</span> <span class="n">search_mode</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find valid single-key characteristics over consecutive rounds.</span>

<span class="sd">    Args:</span>
<span class="sd">        cipher(Cipher): an (iterated) cipher</span>
<span class="sd">        diff_type(Difference): a type of difference</span>
<span class="sd">        initial_weight(int): the initial weight for starting the iterative search</span>
<span class="sd">        solver_name(str): the name of the solver (according to pySMT) to be used</span>
<span class="sd">        start_round(int): the minimum number of rounds to consider</span>
<span class="sd">        end_round(int): the maximum number of rounds to consider</span>
<span class="sd">        der_mode(DerMode): one of the modes available for the derivative weights</span>
<span class="sd">        search_mode(SkChSearchMode): one of the search modes available</span>
<span class="sd">        check(bool): if ``True``, `SkChFound.check_empirical_weight` will be called</span>
<span class="sd">            after a characteristic is found. If it is not valid, the search will continue.</span>
<span class="sd">        verbose_level(int): an integer between ``0`` (no verbose) and ``3`` (full verbose).</span>
<span class="sd">        filename(str): if not ``None``, the output will be  printed to the given file</span>
<span class="sd">            rather than the to stdout.</span>

<span class="sd">    See also `SearchSkCh.solve`.</span>

<span class="sd">        &gt;&gt;&gt; from arxpy.differential.difference import XorDiff</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.smt.search import SkChSearchMode, DerMode, round_based_search_SkCh</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.primitives import speck</span>
<span class="sd">        &gt;&gt;&gt; Speck32 = speck.get_Speck_instance(speck.SpeckInstance.speck_32_64)</span>
<span class="sd">        &gt;&gt;&gt; round_based_search_SkCh(Speck32, XorDiff, 0, &quot;btor&quot;, 1, 2,</span>
<span class="sd">        ...                         DerMode.Default, SkChSearchMode.Optimal, True, 0, None)  # doctest:+ELLIPSIS</span>
<span class="sd">        Num rounds: 1</span>
<span class="sd">        Best characteristic found:</span>
<span class="sd">        {&#39;ch_weight&#39;: 0,</span>
<span class="sd">         &#39;der_weights&#39;: [[w0, 0]],</span>
<span class="sd">         &#39;emp_weight&#39;: Counter({0: 256}),</span>
<span class="sd">         &#39;exact_weight&#39;: 0,</span>
<span class="sd">         &#39;input_diff&#39;: [[dp0, ...], [dp1, ...]],</span>
<span class="sd">         &#39;nonlinear_diffs&#39;: [[dx1, ...]],</span>
<span class="sd">         &#39;output_diff&#39;: [[dx2, ...], [dx4, ...]]}</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        Num rounds: 2</span>
<span class="sd">        Best characteristic found:</span>
<span class="sd">        {&#39;ch_weight&#39;: 1,</span>
<span class="sd">         &#39;der_weights&#39;: [[w0w1, 1]],</span>
<span class="sd">         &#39;emp_weight&#39;: ...,</span>
<span class="sd">         &#39;exact_weight&#39;: 1,</span>
<span class="sd">         &#39;input_diff&#39;: [[dp0, ...], [dp1, ...]],</span>
<span class="sd">         &#39;nonlinear_diffs&#39;: [[dx1, ...], [dx6, ...]],</span>
<span class="sd">         &#39;output_diff&#39;: [[dx7, ...], [dx9, ...]]}</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">start_round</span> <span class="o">&lt;=</span> <span class="n">end_round</span>
    <span class="k">assert</span> <span class="n">search_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">SkChSearchMode</span><span class="o">.</span><span class="n">AllValid</span><span class="p">,</span> <span class="n">SkChSearchMode</span><span class="o">.</span><span class="n">AllOptimal</span><span class="p">]</span>

    <span class="n">smart_print</span> <span class="o">=</span> <span class="n">_get_smart_print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;Single-Key Search</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Parameters:&quot;</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">cipher:&quot;</span><span class="p">,</span> <span class="n">cipher</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">diff_type:&quot;</span><span class="p">,</span> <span class="n">diff_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">initial_weight:&quot;</span><span class="p">,</span> <span class="n">initial_weight</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">solver_name:&quot;</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">start:&quot;</span><span class="p">,</span> <span class="n">start_round</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">end:&quot;</span><span class="p">,</span> <span class="n">end_round</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">der_mode:&quot;</span><span class="p">,</span> <span class="n">der_mode</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">search_mode:&quot;</span><span class="p">,</span> <span class="n">search_mode</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">check:&quot;</span><span class="p">,</span> <span class="n">check</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">verbose_level:&quot;</span><span class="p">,</span> <span class="n">verbose_level</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">filename:&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">num_rounds</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_round</span><span class="p">,</span> <span class="n">end_round</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cipher</span><span class="o">.</span><span class="n">set_rounds</span><span class="p">(</span><span class="n">num_rounds</span><span class="p">)</span>

        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Num rounds:&quot;</span><span class="p">,</span> <span class="n">num_rounds</span><span class="p">)</span>

        <span class="n">ch</span> <span class="o">=</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">SingleKeyCh</span><span class="p">(</span><span class="n">cipher</span><span class="p">,</span> <span class="n">diff_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Characteristic:&quot;</span><span class="p">)</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

        <span class="n">problem</span> <span class="o">=</span> <span class="n">SearchSkCh</span><span class="p">(</span><span class="n">skch</span><span class="o">=</span><span class="n">ch</span><span class="p">,</span> <span class="n">der_mode</span><span class="o">=</span><span class="n">der_mode</span><span class="p">,</span> <span class="n">allow_zero_input_diff</span><span class="o">=</span><span class="n">initial_weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;SMT problem (size </span><span class="si">{}</span><span class="s2">):&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">formula_size</span><span class="p">()))</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">hrepr</span><span class="p">(</span><span class="n">full_repr</span><span class="o">=</span><span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">))</span>

        <span class="n">ch_found</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">initial_weight</span><span class="p">,</span> <span class="n">solver_name</span><span class="o">=</span><span class="n">solver_name</span><span class="p">,</span> <span class="n">search_mode</span><span class="o">=</span><span class="n">search_mode</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="n">check</span><span class="p">,</span>
                                 <span class="n">verbose_level</span><span class="o">=</span><span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_get_time</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot; | &quot;</span>
            <span class="n">smart_print</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">ch_found</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;No characteristic found&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">SkChSearchMode</span><span class="o">.</span><span class="n">TopDifferentials</span><span class="p">:</span>
                <span class="n">ch_found</span><span class="p">,</span> <span class="n">top_differentials</span> <span class="o">=</span> <span class="n">ch_found</span>
            <span class="n">initial_weight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ch_found</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">)</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;Best characteristic found:&quot;</span><span class="p">)</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="n">ch_found</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">smart_print</span><span class="p">(</span><span class="n">ch_found</span><span class="o">.</span><span class="n">vrepr</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="n">SkChSearchMode</span><span class="o">.</span><span class="n">TopDifferentials</span><span class="p">:</span>
                <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Best differentials found:&quot;</span><span class="p">)</span>
                <span class="n">smart_print</span><span class="p">(</span><span class="n">top_differentials</span><span class="p">)</span>
            <span class="n">smart_print</span><span class="p">()</span></div>


<div class="viewcode-block" id="round_based_search_RkCh"><a class="viewcode-back" href="../../../arxpy.smt.search.html#arxpy.smt.search.round_based_search_RkCh">[docs]</a><span class="k">def</span> <span class="nf">round_based_search_RkCh</span><span class="p">(</span><span class="n">cipher</span><span class="p">,</span> <span class="n">diff_type</span><span class="p">,</span> <span class="n">initial_ew</span><span class="p">,</span> <span class="n">initial_kw</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">,</span>
                            <span class="n">start_round</span><span class="p">,</span> <span class="n">end_round</span><span class="p">,</span> <span class="n">key_der_mode</span><span class="p">,</span> <span class="n">enc_der_mode</span><span class="p">,</span> <span class="n">allow_zero_enc_input_diff</span><span class="p">,</span>
                            <span class="n">search_mode</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>
                            <span class="n">allow_zero_key_input_diff</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>  <span class="c1"># for RXDiff</span>
    <span class="sd">&quot;&quot;&quot;Find valid related-key characteristics over consecutive rounds.</span>

<span class="sd">    Args:</span>
<span class="sd">        cipher(Cipher): an (iterated) cipher</span>
<span class="sd">        diff_type(Difference): a type of difference</span>
<span class="sd">        initial_ew(int): the initial encryption weight for starting the iterative search</span>
<span class="sd">        initial_kw(int): the initial key schedule weight for starting the iterative search</span>
<span class="sd">        solver_name(str): the name of the solver (according to pySMT) to be used</span>
<span class="sd">        start_round(int): the minimum number of rounds to consider</span>
<span class="sd">        end_round(int): the maximum number of rounds to consider</span>
<span class="sd">        key_der_mode(DerMode):  the derivative mode for the key schedule characteristic</span>
<span class="sd">        enc_der_mode(DerMode):  the derivative mode for the encryption characteristic</span>
<span class="sd">        allow_zero_enc_input_diff (bool): if ``True``, allow the input difference</span>
<span class="sd">            of the encryption to be zero</span>
<span class="sd">        search_mode(RkChSearchMode): one of the search modes available</span>
<span class="sd">        check(bool): if ``True``, `RkChFound.check_empirical_weight` will be called</span>
<span class="sd">            after a characteristic is found. If it is not valid, the search will continue.</span>
<span class="sd">        verbose_level(int): an integer between ``0`` (no verbose) and ``3`` (full verbose).</span>
<span class="sd">        filename(str): if not ``None``, the output will be  printed to the given file</span>
<span class="sd">            rather than the to stdout.</span>
<span class="sd">        allow_zero_key_input_diff (bool): if ``True``, allow the input difference</span>
<span class="sd">            of the key schedule to be zero.</span>

<span class="sd">    See also `SearchRkCh.solve`.</span>

<span class="sd">        &gt;&gt;&gt; from arxpy.differential.difference import XorDiff, RXDiff</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.smt.search import RkChSearchMode, DerMode, round_based_search_RkCh</span>
<span class="sd">        &gt;&gt;&gt; from arxpy.primitives import speck</span>
<span class="sd">        &gt;&gt;&gt; Speck32 = speck.get_Speck_instance(speck.SpeckInstance.speck_32_64)</span>
<span class="sd">        &gt;&gt;&gt; round_based_search_RkCh(Speck32, XorDiff, 0, 0, &quot;btor&quot;,</span>
<span class="sd">        ...                         4, 5, DerMode.Default, DerMode.Default, True,</span>
<span class="sd">        ...                         RkChSearchMode.OptimalMinSum, True, 0, None)  # doctest:+ELLIPSIS</span>
<span class="sd">        Num rounds: 4</span>
<span class="sd">        Best related-key characteristic found:</span>
<span class="sd">        {&#39;enc_ch_found&#39;: {&#39;ch_weight&#39;: 0,</span>
<span class="sd">                          &#39;der_weights&#39;: [[w0w1w2, 0], [w3, 0]],</span>
<span class="sd">                          &#39;emp_weight&#39;: Counter({0: 256}),</span>
<span class="sd">                          &#39;exact_weight&#39;: 0,</span>
<span class="sd">                          &#39;input_diff&#39;: [[dp0, ...], [dp1, ...]],</span>
<span class="sd">                          &#39;nonlinear_diffs&#39;: [[dx1, ...], [dx6, ...], [dx11, ...], [dx16, ...]],</span>
<span class="sd">                          &#39;output_diff&#39;: [[dx17, ...], [dx19, ...]]},</span>
<span class="sd">         &#39;key_ch_found&#39;: {&#39;ch_weight&#39;: 0,</span>
<span class="sd">                          &#39;der_weights&#39;: [[wk0wk1wk2, 0]],</span>
<span class="sd">                          &#39;emp_weight&#39;: 0.0,</span>
<span class="sd">                          &#39;exact_weight&#39;: 0,</span>
<span class="sd">                          &#39;input_diff&#39;: [[dmk0, ...], [dmk1, ...], [dmk2, ...], [dmk3, ...]],</span>
<span class="sd">                          &#39;nonlinear_diffs&#39;: [[dk1, ...], [dk5, ...], [dk10, ...]],</span>
<span class="sd">                          &#39;output_diff&#39;: [[dmk3, ...], [dk3, ...], [dk8, ...], [dk13, ...]]}}</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        Num rounds: 5</span>
<span class="sd">        Best related-key characteristic found:</span>
<span class="sd">        {&#39;enc_ch_found&#39;: {&#39;ch_weight&#39;: 1,</span>
<span class="sd">                          &#39;der_weights&#39;: [[w0w1w2, 0], [w3w4, 1]],</span>
<span class="sd">                          &#39;emp_weight&#39;: ...,</span>
<span class="sd">                          &#39;exact_weight&#39;: 1,</span>
<span class="sd">                          &#39;input_diff&#39;: [[dp0, ...], [dp1, ...]],</span>
<span class="sd">                          &#39;nonlinear_diffs&#39;: [[dx1, ...], [dx6, ...], [dx11, ...], [dx16, ...], [dx21, ...]],</span>
<span class="sd">                          &#39;output_diff&#39;: [[dx22, ...], [dx24, ...]]},</span>
<span class="sd">         &#39;key_ch_found&#39;: {&#39;ch_weight&#39;: 0,</span>
<span class="sd">                          &#39;der_weights&#39;: [[wk0wk1wk2, 0], [wk3, 0]],</span>
<span class="sd">                          &#39;emp_weight&#39;: 0.0,</span>
<span class="sd">                          &#39;exact_weight&#39;: 0,</span>
<span class="sd">                          &#39;input_diff&#39;: [[dmk0, ...], [dmk1, ...], [dmk2, ...], [dmk3, ...]],</span>
<span class="sd">                          &#39;nonlinear_diffs&#39;: [[dk1, ...], [dk5, ...], [dk10, ...], [dk15, ...]],</span>
<span class="sd">                          &#39;output_diff&#39;: [[dmk3, ...], [dk3, ...], [dk8, ...], [dk13, ...], [dk18, ...]]}}</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; round_based_search_RkCh(Speck32, RXDiff, 0, 0, &quot;btor&quot;,</span>
<span class="sd">        ...                         2, 3, DerMode.Default, DerMode.Default, True,</span>
<span class="sd">        ...                         RkChSearchMode.FirstMinSumValid, True, 0, None, True)  # doctest:+ELLIPSIS</span>
<span class="sd">        Num rounds: 2</span>
<span class="sd">        Best related-key characteristic found:</span>
<span class="sd">        {&#39;enc_ch_found&#39;: {&#39;ch_weight&#39;: 2,</span>
<span class="sd">                          &#39;der_weights&#39;: [[w0, ...], [w1, ...]],</span>
<span class="sd">                          &#39;emp_weight&#39;: ...,</span>
<span class="sd">                          &#39;exact_weight&#39;: 2.829986944784033,</span>
<span class="sd">                          &#39;input_diff&#39;: [[dp0, ...], [dp1, ...]],</span>
<span class="sd">                          &#39;nonlinear_diffs&#39;: [[dx1, ...], [dx6, ...]],</span>
<span class="sd">                          &#39;output_diff&#39;: [[dx7, ...], [dx9, ...]]},</span>
<span class="sd">         &#39;key_ch_found&#39;: {&#39;ch_weight&#39;: 1,</span>
<span class="sd">                          &#39;der_weights&#39;: [[wk0, ...]],</span>
<span class="sd">                          &#39;emp_weight&#39;: ...,</span>
<span class="sd">                          &#39;exact_weight&#39;: 1.4149934723920166,</span>
<span class="sd">                          &#39;input_diff&#39;: [[dmk0, ...], [dmk1, ...]],</span>
<span class="sd">                          &#39;nonlinear_diffs&#39;: [[dk1, ...]],</span>
<span class="sd">                          &#39;output_diff&#39;: [[dmk1, ...], [dk3, ...]]}}</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        Num rounds: 3</span>
<span class="sd">        Best related-key characteristic found:</span>
<span class="sd">        {&#39;enc_ch_found&#39;: {&#39;ch_weight&#39;: 4,</span>
<span class="sd">                          &#39;der_weights&#39;: [[w0, ...], [w1, ...], [w2, ...]],</span>
<span class="sd">                          &#39;emp_weight&#39;: ...,</span>
<span class="sd">                          &#39;exact_weight&#39;: 4.24498041717605,</span>
<span class="sd">                          &#39;input_diff&#39;: [[dp0, ...], [dp1, ...]],</span>
<span class="sd">                          &#39;nonlinear_diffs&#39;: [[dx1, ...], [dx6, ...], [dx11, ...]],</span>
<span class="sd">                          &#39;output_diff&#39;: [[dx12, ...], [dx14, ...]]},</span>
<span class="sd">         &#39;key_ch_found&#39;: {&#39;ch_weight&#39;: 2,</span>
<span class="sd">                          &#39;der_weights&#39;: [[wk0, ...], [wk1, ...]],</span>
<span class="sd">                          &#39;emp_weight&#39;: ...,</span>
<span class="sd">                          &#39;exact_weight&#39;: 2.829986944784033,</span>
<span class="sd">                          &#39;input_diff&#39;: [[dmk0, ...], [dmk1, ...], [dmk2, ...]],</span>
<span class="sd">                          &#39;nonlinear_diffs&#39;: [[dk1, ...], [dk5, ...]],</span>
<span class="sd">                          &#39;output_diff&#39;: [[dmk2, ...], [dk3, ...], [dk8, ...]]}}</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">start_round</span> <span class="o">&lt;=</span> <span class="n">end_round</span>
    <span class="k">assert</span> <span class="n">search_mode</span> <span class="o">!=</span> <span class="n">RkChSearchMode</span><span class="o">.</span><span class="n">AllValid</span>

    <span class="n">smart_print</span> <span class="o">=</span> <span class="n">_get_smart_print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;Related-Key Search</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Parameters:&quot;</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">cipher:&quot;</span><span class="p">,</span> <span class="n">cipher</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">diff_type:&quot;</span><span class="p">,</span> <span class="n">diff_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">initial_ew:&quot;</span><span class="p">,</span> <span class="n">initial_ew</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">initial_kw:&quot;</span><span class="p">,</span> <span class="n">initial_kw</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">solver_name:&quot;</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">start:&quot;</span><span class="p">,</span> <span class="n">start_round</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">end:&quot;</span><span class="p">,</span> <span class="n">end_round</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">key_der_mode:&quot;</span><span class="p">,</span> <span class="n">key_der_mode</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">enc_der_mode:&quot;</span><span class="p">,</span> <span class="n">enc_der_mode</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">allow_zero_enc_input_diff:&quot;</span><span class="p">,</span> <span class="n">allow_zero_enc_input_diff</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">search_mode:&quot;</span><span class="p">,</span> <span class="n">search_mode</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">check:&quot;</span><span class="p">,</span> <span class="n">check</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">verbose_level:&quot;</span><span class="p">,</span> <span class="n">verbose_level</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">filename:&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">smart_print</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">num_rounds</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_round</span><span class="p">,</span> <span class="n">end_round</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cipher</span><span class="o">.</span><span class="n">set_rounds</span><span class="p">(</span><span class="n">num_rounds</span><span class="p">)</span>

        <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Num rounds:&quot;</span><span class="p">,</span> <span class="n">num_rounds</span><span class="p">)</span>

        <span class="n">ch</span> <span class="o">=</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">RelatedKeyCh</span><span class="p">(</span><span class="n">cipher</span><span class="p">,</span> <span class="n">diff_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;Characteristic:&quot;</span><span class="p">)</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

        <span class="n">problem</span> <span class="o">=</span> <span class="n">SearchRkCh</span><span class="p">(</span><span class="n">rkch</span><span class="o">=</span><span class="n">ch</span><span class="p">,</span> <span class="n">key_der_mode</span><span class="o">=</span><span class="n">key_der_mode</span><span class="p">,</span> <span class="n">enc_der_mode</span><span class="o">=</span><span class="n">enc_der_mode</span><span class="p">,</span>
                             <span class="n">allow_zero_enc_input_diff</span><span class="o">=</span><span class="n">allow_zero_enc_input_diff</span><span class="p">,</span>
                             <span class="n">allow_zero_key_input_diff</span><span class="o">=</span><span class="n">allow_zero_key_input_diff</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="s2">&quot;SMT problem (size </span><span class="si">{}</span><span class="s2">):&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">formula_size</span><span class="p">()))</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">hrepr</span><span class="p">(</span><span class="n">full_repr</span><span class="o">=</span><span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">))</span>

        <span class="n">rkch_found</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">initial_ew</span><span class="p">,</span> <span class="n">initial_kw</span><span class="p">,</span> <span class="n">solver_name</span><span class="o">=</span><span class="n">solver_name</span><span class="p">,</span> <span class="n">search_mode</span><span class="o">=</span><span class="n">search_mode</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="n">check</span><span class="p">,</span>
                                   <span class="n">verbose_level</span><span class="o">=</span><span class="n">verbose_level</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_get_time</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot; | &quot;</span>
            <span class="n">smart_print</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">rkch_found</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;No related-key characteristic found&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">initial_ew</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rkch_found</span><span class="o">.</span><span class="n">enc_ch_found</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">)</span>
            <span class="n">initial_kw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rkch_found</span><span class="o">.</span><span class="n">key_ch_found</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">)</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;Best related-key characteristic found:&quot;</span><span class="p">)</span>
            <span class="n">smart_print</span><span class="p">(</span><span class="n">rkch_found</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">smart_print</span><span class="p">(</span><span class="n">rkch_found</span><span class="o">.</span><span class="n">vrepr</span><span class="p">())</span>
            <span class="n">smart_print</span><span class="p">()</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Adrian Ranea

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>